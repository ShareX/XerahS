# Linux Hardening & Bugfixes Plan

This plan addresses a set of related bugs observed in the Linux environment, specifically concerning D-Bus introspection failures and missing built-in plugins.

## 1. D-Bus Extrospection "Duplicate Type" Bug

**Observation:**
The log indicates D-Bus introspection failing repeatedly:
`PortalInterfaceChecker: D-Bus introspection failed for 'org.freedesktop.portal.InputCapture'. Falling back to busctl. Details: ArgumentException: Duplicate type name within an assembly.`

**Cause:**
`Tmds.DBus` uses `Reflection.Emit` to dynamically build proxy classes for interfaces. The `IIntrospectable` interface in `XerahS.Platform.Linux.Services.PortalInterfaceChecker.cs` is marked `internal`. The first time `connection.CreateProxy<IIntrospectable>` is called, the dynamically generated assembly (`Tmds.DBus.Emit`) throws a `TypeLoadException` because it cannot implement an inaccessible `internal` interface. This leaves the dynamic assembly in a corrupted state for this type name. Subsequent calls to `CreateProxy<IIntrospectable>` then crash with `ArgumentException: Duplicate type name within an assembly` instead of succeeding or throwing the original error.

**Fix:**
Change the visibility of `IIntrospectable` to `public` so that the `Tmds.DBus.Emit` assembly can successfully implement the proxy.

#### [MODIFY] [PortalInterfaceChecker.cs](file:///home/Public/GitHub/ShareXteam/XerahS/src/platform/XerahS.Platform.Linux/Services/PortalInterfaceChecker.cs)

```diff
-[DBusInterface("org.freedesktop.DBus.Introspectable")]
-internal interface IIntrospectable : IDBusObject
+{
+[DBusInterface("org.freedesktop.DBus.Introspectable")]
+public interface IIntrospectable : IDBusObject
+{
     Task<string> IntrospectAsync();
 }
```

## 2. Missing App-Bundled Plugins (e.g. Amazon S3)

**Observation:**
The application fails to locate built-in providers (like `amazons3`) and logs the following:
`Provider not found in catalog: amazons3`
And in the plugin verification stage:
`[UploaderInstanceVM] Plugin verification for amazons3: Warning - ⚠️ Plugin folder has 0 files (expected 3)`
However, the plugin files are known to be bundled inside the RPM release at `/usr/lib/xerahs/Plugins/amazons3`. The log indicates only `/home/xf/Documents/XerahS/Plugins` is being scanned.

**Cause:**
In .NET Core single-file deployments on Linux (`PublishSingleFile=true`), `AppDomain.CurrentDomain.BaseDirectory` can return an empty or incorrect path compared to `AppContext.BaseDirectory` (which strictly resolves to the directory containing the bundled executable, i.e., `/usr/lib/xerahs/`). 
`PathsManager.cs` currently uses `Path.Combine(AppDomain.CurrentDomain.BaseDirectory, AppResources.PluginsFolderName)`, which fails to resolve to the true application directory `/usr/lib/xerahs/Plugins` and causes `Directory.Exists` to fail. Consequently, the app-bundled plugins directory is silently discarded from the search paths, leading to missing providers. The verification warning happens because it predictably falls back to the user's plugin folder, finding an empty override directory.

**Fix:**
Update `PathsManager.PluginsFolder` and `PathsManager.GetPluginDirectories()` to consistently use `AppContext.BaseDirectory` instead of `AppDomain.CurrentDomain.BaseDirectory`.

#### [MODIFY] [PathsManager.cs](file:///home/Public/GitHub/ShareXteam/XerahS/src/desktop/core/XerahS.Common/PathsManager.cs)

```diff
         public static string PluginsFolder
         {
             get
             {
 #if DEBUG
                 if (OperatingSystem.IsIOS() || OperatingSystem.IsAndroid())
                     return Path.Combine(PersonalFolder, AppResources.PluginsFolderName);
-                return Path.Combine(AppDomain.CurrentDomain.BaseDirectory, AppResources.PluginsFolderName);
+                return Path.Combine(AppContext.BaseDirectory, AppResources.PluginsFolderName);
 #else
                 return Path.Combine(PersonalFolder, AppResources.PluginsFolderName);
 #endif
             }
         }
```

```diff
         public static System.Collections.Generic.IEnumerable<string> GetPluginDirectories()
         {
             var paths = new System.Collections.Generic.List<string>();
 
             // 1. App-bundled plugins (BaseDirectory/Plugins)
             // In Release, we also want to check this location adjacent to the executable
-            string appPluginsPath = Path.Combine(AppDomain.CurrentDomain.BaseDirectory, AppResources.PluginsFolderName);
+            string appPluginsPath = Path.Combine(AppContext.BaseDirectory, AppResources.PluginsFolderName);
             if (Directory.Exists(appPluginsPath))
             {
                 paths.Add(appPluginsPath);
             }
```

## Verification Plan

### Automated Tests
- Build the project using `dotnet build src/XerahS.sln`.
- Verify the DBus interfaces using the existing test runner if any.

### Manual Verification
- Review the `PortalInterfaceChecker.cs` modification to assure it's valid syntax.
- Review the `PathsManager.cs` modification to assure it correctly aligns with `.NET 10` best practices (where `AppContext.BaseDirectory` is the gold standard for single-file deployment).
