# Linux Log-Driven Stability and Diagnostics Hardening Plan

## Summary
This plan addresses all high-signal failures in `/home/xf/Documents/XerahS/Logs/2026-02/XerahS-20260218.log` and `/home/xf/Documents/XerahS/CaptureTroubleshooting/linux-recording-diagnostics_20260218_065206.log`, with concrete code fixes plus richer diagnostics for next incident triage.

Primary issues observed:
1. Startup hard crash: `XOpenDisplay failed` (`/home/xf/Documents/XerahS/Logs/2026-02/XerahS-20260218.log:68`, `:78`).
2. Portal interface probing failed due `busctl` process start errors (`:61`, `:63`, `:65`).
3. Wayland hotkey binding repeatedly failed (`BindShortcuts failed (2)`) (`:337`, `:345`, `:352`, `:359`, `:366`, repeated later).
4. Unobserved DBus task exception (`ServiceUnknown`) (`:934`).
5. Recording pipeline fatal error from incompatible VP9 property (`deadline=realtime`) (`:1023`, `:1028`).
6. Recording error still surfaced as successful task/toast (`:1025` then `:1038` and `:1039`).
7. File upload failed from missing File-category uploader instance (`:1090` onward).

## Implementation Plan
1. Fix recording pipeline compatibility and prevent false-success completion.
- Edit `src/XerahS.Platform.Linux/Recording/WaylandPortalRecordingService.cs:1078` to stop emitting incompatible `vp9enc deadline=realtime`; use a compatibility-safe VP9 encoder argument set.
- Add explicit log of final encoder args and compatibility decision in `src/XerahS.Platform.Linux/Recording/WaylandPortalRecordingService.cs`.
- Edit `src/XerahS.Core/Tasks/WorkerTaskRecording.cs:109` to hard-fail when `StopRecordingAsync()` yields no existing output file after recovery attempts; throw a recording workflow exception instead of continuing silently.
- Add contextual failure log (expected path, recovered path, existence checks) in `src/XerahS.Core/Tasks/WorkerTaskRecording.cs`.

2. Eliminate unobserved portal response exceptions.
- Edit `src/XerahS.Platform.Linux/Capture/PortalRequestExtensions.cs:39` to pass an `error` callback into `WatchResponseAsync`, complete the `TaskCompletionSource` with exception, and ensure the exception is observed by awaiting callers.
- Add one explicit diagnostic line for response-watch failures with DBus error name/message in `src/XerahS.Platform.Linux/Capture/PortalRequestExtensions.cs`.

3. Make Wayland hotkey failures degrade to X11 fallback (per your choice).
- Edit `src/XerahS.Platform.Linux/Services/WaylandPortalHotkeyService.cs:79` to detect `BindShortcuts` response code `2` as non-recoverable for current session.
- Add portal response code mapping and hotkey binding payload logging in `src/XerahS.Platform.Linux/Services/WaylandPortalHotkeyService.cs`.
- On first `BindShortcuts(2)`, activate fallback `LinuxHotkeyService`, replay registrations, and route subsequent register/unregister/is-registered calls through fallback service in `src/XerahS.Platform.Linux/Services/WaylandPortalHotkeyService.cs`.
- Forward fallback `HotkeyTriggered` events so `WorkflowManager` behavior remains unchanged.

4. Remove brittle portal interface detection dependency on external `busctl`.
- Edit `src/XerahS.Platform.Linux/Services/PortalInterfaceChecker.cs:46` to use DBus introspection (`org.freedesktop.DBus.Introspectable`) as primary interface detection path.
- Keep `busctl` probing only as fallback path, with explicit startup diagnostics: command, cwd, PATH presence, exception type, and exit code in `src/XerahS.Platform.Linux/Services/PortalInterfaceChecker.cs`.
- This removes false negatives caused by missing command binaries or process-launch context problems.

5. Auto-bootstrap File uploads via Auto destination instance (per your choice).
- Edit `src/XerahS.Core/Tasks/Processors/UploadJobProcessor.cs:131` to detect missing File-category destination and auto-create/select an Auto uploader instance when absent.
- Persist the created Auto instance through `InstanceManager` and set it as File default in `src/XerahS.Core/Tasks/Processors/UploadJobProcessor.cs`.
- Add deterministic bootstrap logging marker `[UploadAutoBootstrap]` with instance ID and category.
- Edit `src/Plugins/ShareX.Auto.Plugin/AutoUploader.cs:40` so File uploads route by file type priority (`Image` then `Text` then `File`) when resolving targets, instead of only trying File category.
- Return actionable error text when no downstream non-auto target exists in any category.

6. Improve startup and diagnostic visibility for future triage.
- Edit `src/XerahS.App/Program.cs:176` to expand display-environment logs: `CurrentDirectory`, `AppContext.BaseDirectory`, `XDG_RUNTIME_DIR`, display socket path checks, flatpak indicators.
- Stop auto-setting synthetic `DISPLAY`/`WAYLAND_DISPLAY` defaults in `src/XerahS.App/Program.cs:203` to avoid masking root causes with guessed values.
- Edit `src/XerahS.Platform.Linux/Services/LinuxDiagnosticService.cs:69` to add new report sections:
  - process execution context (cwd, PATH, sandbox markers),
  - absolute command resolution (`which` output, not just OK/Missing),
  - VP9 encoder capability snapshot (relevant `gst-inspect-1.0 vp9enc` properties),
  - portal probe method and probe outcome source.

## Important API / Interface / Type Changes
1. No breaking public API changes across user-facing contracts.
2. Internal behavior changes:
- `WaylandPortalHotkeyService` will dynamically switch backend behavior at runtime when portal bind fails.
- `UploadJobProcessor` will mutate uploader-instance configuration by creating an Auto File instance when required.
- `AutoUploader` routing semantics for File uploads will become multi-category.

## Test Cases and Scenarios
1. Startup resilience scenario.
- Launch on Linux session lacking usable display backend.
- Expected: no opaque crash loop; logs include concrete display/runtime diagnostics and actionable failure context.

2. Wayland recording scenario with FFmpeg missing and GStreamer available.
- Trigger region recording on Wayland.
- Expected: no VP9 `deadline` property failure; recording starts and output file exists.

3. Recording failure propagation scenario.
- Force recording backend failure.
- Expected: task becomes Failed (not Completed), and success toast is not shown.

4. Portal watch error scenario.
- Simulate portal request watch error (`ServiceUnknown`).
- Expected: exception is observed in normal control flow; no `Unobserved task exception` log entry.

5. Hotkey portal failure fallback scenario.
- Simulate `BindShortcuts` response code `2`.
- Expected: one fallback activation log; subsequent hotkey registrations use X11 fallback path.

6. Missing File uploader scenario.
- Start FileUpload with no File uploader instances configured.
- Expected: Auto File instance is created/selected automatically; upload resolves via category-aware auto routing.

7. Diagnostics output validation scenario.
- Generate Linux recording diagnostics report.
- Expected: new context sections are present and include command-resolution and encoder-capability detail.

## Assumptions and Defaults
1. `BindShortcuts` response code `2` is treated as non-recoverable for current Wayland portal hotkey session.
2. X11 fallback for hotkeys is best-effort; if X display is unavailable, failure is explicit and non-crashing.
3. Auto File uploader bootstrap is one-time per config state and is persisted for subsequent runs.
4. File upload auto-routing preference order is `Image -> Text -> File` for FileUpload content.
5. EIS connection failure in input capture remains non-fatal and will continue using cursor fallback behavior.
