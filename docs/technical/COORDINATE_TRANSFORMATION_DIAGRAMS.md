# Multi-Monitor Region Capture - Visual Diagrams

## Problem Illustration

### Before Fix: Coordinate Mismatch on Multi-Monitor

```
PHYSICAL SCREEN LAYOUT:
?????????????????????????????????????????????
?  Monitor 1          ?  Monitor 2          ?
?  1920x1080          ?  1920x1080          ?
?  @ 100% DPI         ?  @ 125% DPI         ?
?  Physical: 0-1920   ?  Physical: 1920-3840?
?????????????????????????????????????????????

USER SELECTION (Physical):
?????????????????????????????????????????????
?  Monitor 1          ?  Monitor 2          ?
?  [========USER======]====DRAG====]        ?
?  X=200, Y=100       ?  X=2200, Y=200      ?
?  Size: 2000x100     ?                     ?
?????????????????????????????????????????????

BACKGROUND SCREENSHOT (BEFORE FIX):
? Uses hardcoded 1920x1080 @ (0,0)
? Misses right half of selection
? Offset appears because bounds don't match
```

### After Fix: Proper Coordinate System

```
VIRTUAL SCREEN BOUNDS CALCULATION:
Virtual Origin:    (0, 0)
Virtual Size:      3840 x 1080
RenderScaling:     1.25 (from Monitor 2)

COORDINATE CONVERSION PROCESS:
Global Physical ? Logical Rendering
  ?
User clicks at X=2200 (on Monitor 2)
  ?
Logical X = (2200 - 0) / 1.25 = 1760
  ?
Canvas renders selection at logical 1760
  ?
OS renders logical 1760 * 1.25 = 2200 physical ?
```

---

## Coordinate System Transformation

### Single Monitor (Simple Case)

```
PHYSICAL COORDINATES:
User at 500, 300 on 1920x1080 screen @ (0,0)

?
?? GetCursorPos() ? (500, 300) [GLOBAL PHYSICAL]
?
?? Virtual Screen Offset: 0, 0
?? RenderScaling: 1.0
?
?? Logical = (500 - 0) / 1.0 = 500
?
?? Canvas draws at 500 ?
?
?? Result returned: (500, 300) [GLOBAL PHYSICAL] ?
```

### Dual Monitor with Negative Offset (Complex Case)

```
PHYSICAL LAYOUT:
???????????????????????????????????
? Monitor 1      ? Monitor 2      ?
? 1920x1080      ? 1920x1080      ?
? @ -1920-0      ? @ 0-1920       ?
? 100% DPI       ? 100% DPI       ?
???????????????????????????????????
  Physical: -1920          Physical: 0

TRANSFORMATION:
User at -500, 300 (left monitor)

?
?? GetCursorPos() ? (-500, 300) [GLOBAL PHYSICAL ? Negative!]
?
?? Virtual Screen Offset: -1920, 0  ? Stored during init
?? RenderScaling: 1.0
?
?? Logical = (-500 - (-1920)) / 1.0 = 1420
?
?? Canvas draws at 1420 ?
?
?? Result returned: (-500, 300) [GLOBAL PHYSICAL] ?
```

### Mixed DPI (Most Complex)

```
PHYSICAL LAYOUT:
???????????????????????????????????
? Monitor 1      ? Monitor 2      ?
? 1920x1080      ? 1920x1080      ?
? @ -1920-0      ? @ 0-1920       ?
? 100% DPI       ? 125% DPI       ?
???????????????????????????????????

Virtual Bounds: (-1920, 0, 3840, 1080)
RenderScaling: 1.25 (from Monitor 2)

TRANSFORMATION - Right Monitor:
User at 1920, 300 (right monitor)

?
?? GetCursorPos() ? (1920, 300) [GLOBAL PHYSICAL]
?
?? Virtual Screen Offset: -1920, 0
?? RenderScaling: 1.25
?
?? Logical X = (1920 - (-1920)) / 1.25 = 3840 / 1.25 = 3072
?? Logical Y = (300 - 0) / 1.25 = 240
?
?? Canvas draws at (3072, 240) ?
?
?? OS renders at (3072 * 1.25, 240 * 1.25) = (3840, 300) ?
?
?? Result returned: (1920, 300) [GLOBAL PHYSICAL] ?
```

---

## DPI Scaling Comparison

### WRONG: Inverse Transform (Before Fix)

```
Window Physical Size: 3840 x 1080
RenderScaling: 1.25

Step 1: Set window width
Width = 3840  ? Physical size in logical units

Step 2: Apply inverse transform
canvas.RenderTransform = Scale(1/1.25) = Scale(0.8)

Step 3: Rendering
Avalonia canvas ? 3840 logical
Inverse transform ? 3840 * 0.8 = 3072 ?
RenderScaling ? 3072 * 1.25 = 3840 ?

RESULT: Correct final size, but VISUALLY ZOOMED ?
(Content appears 1.25x larger than physical)
```

### CORRECT: Logical Sizing (After Fix)

```
Window Physical Size: 3840 x 1080
RenderScaling: 1.25

Step 1: Calculate logical size
Width = 3840 / 1.25 = 3072  ? Already in logical units

Step 2: Set window width
Width = 3072 logical

Step 3: Rendering
Avalonia canvas ? 3072 logical
No transform
RenderScaling ? 3072 * 1.25 = 3840 ?

RESULT: Correct final size AND correct appearance ?
(Content size matches physical reality)
```

---

## Virtual Screen Bounds Calculation

### WRONG: Starting from 0 (Before Fix)

```
Monitors:
  Screen 1: X=0, Y=0, Right=1920, Bottom=1080
  Screen 2: X=-1920, Y=0, Right=0, Bottom=1080

Initialize:
  minX = 0      ? WRONG: Assumes 0 is minimum
  minY = 0
  maxX = 0
  maxY = 0

Loop:
  minX = min(0, 0) = 0        ? Still 0!
  minX = min(0, -1920) = -1920  ? TOO LATE, already used 0
  
Result: INCORRECT BOUNDS ?
```

### CORRECT: Starting from extremes (After Fix)

```
Monitors:
  Screen 1: X=0, Y=0, Right=1920, Bottom=1080
  Screen 2: X=-1920, Y=0, Right=0, Bottom=1080

Initialize:
  minX = int.MaxValue   ? Highest possible value
  minY = int.MaxValue
  maxX = int.MinValue   ? Lowest possible value
  maxY = int.MinValue

Loop:
  minX = min(MaxValue, 0) = 0
  minX = min(0, -1920) = -1920  ? Correctly finds true minimum
  maxX = max(MinValue, 1920) = 1920
  maxX = max(1920, 0) = 1920    ? Correctly finds true maximum

Result: CORRECT BOUNDS ?
  Virtual: (-1920, 0) to (1920, 1080)
  Size: 3840 x 1080
```

---

## Selection Rendering Process

### Visual Flow

```
???????????????????????????????????????????????????????????
? USER INTERACTION LAYER                                  ?
???????????????????????????????????????????????????????????
                   ?
                   ? GetCursorPos() [Physical]
???????????????????????????????????????????????????????????
? COORDINATE CONVERSION LAYER                             ?
?                                                         ?
?  Global Physical (e.g., -500)                          ?
?           ?                                            ?
?  Subtract Offset (- (-1920)) = 1420                    ?
?           ?                                            ?
?  Divide by Scale (/ 1.0) = 1420                        ?
?           ?                                            ?
?  Logical Coordinate (1420)                             ?
???????????????????????????????????????????????????????????
                   ?
                   ?
???????????????????????????????????????????????????????????
? RENDERING LAYER (Avalonia Canvas)                       ?
?                                                         ?
?  Set Canvas element at logical position 1420 ?         ?
?  Canvas size: 3072 logical (after division by 1.25)    ?
?                                                         ?
?  Background image:                                      ?
?    ?? 3072 x 864 logical                               ?
?       Rendered by OS at 3840 x 1080 physical           ?
?                                                         ?
?  Selection rectangle:                                   ?
?    ?? Position 1420, Size 800                          ?
?       Rendered by OS at physical equivalent            ?
???????????????????????????????????????????????????????????
                   ?
                   ? OnPointerReleased()
???????????????????????????????????????????????????????????
? RESULT CONVERSION LAYER                                 ?
?                                                         ?
?  Logical ? Global Physical                             ?
?  Coordinate: 1420                                       ?
?  Multiply by Scale (* 1.0) = 1420                       ?
?  Add Offset (+ (-1920)) = -500                          ?
?           ?                                            ?
?  Global Physical: -500 ?                               ?
???????????????????????????????????????????????????????????
                   ?
                   ?
???????????????????????????????????????????????????????????
? CAPTURE LAYER (GDI+)                                    ?
?                                                         ?
?  CopyFromScreen(-500, y, width, height) ?              ?
?  Uses global physical coordinates directly             ?
???????????????????????????????????????????????????????????
```

---

## Error Cases and Fixes

### Error Case 1: Negative Coordinate at Edge

```
BEFORE FIX:
  Setup: Left monitor at X=-1920
  User clicks at X=-10 (near left edge)
  
  Calculation: minX = 0
  Result: minX never becomes -1920
  Bounds: (0, 0, 1920, 1080)  ? WRONG
  Offset: 1920 pixels ?

AFTER FIX:
  Initialize minX = int.MaxValue
  Loop finds: minX = -1920 ?
  Bounds: (-1920, 0, 3840, 1080)  ? CORRECT
  User at -10 maps to logical: (-10 - (-1920)) = 1910 ?
```

### Error Case 2: Double Scaling on High DPI

```
BEFORE FIX:
  RenderScaling: 1.25
  Window Width: 3840
  
  Canvas.RenderTransform = Scale(1/1.25) = Scale(0.8)
  
  Rendering:
  Logical Size: 3840
  After 0.8 transform: 3072
  After 1.25 scale: 3840 ? Correct size
  But visually: 3840/3072 = 1.25x zoomed ?

AFTER FIX:
  RenderScaling: 1.25
  Window Width: 3840 / 1.25 = 3072 ? Logical already
  
  Canvas.RenderTransform: null
  
  Rendering:
  Logical Size: 3072
  No transform: 3072
  After 1.25 scale: 3840 ? Correct size ?
  Visually: Correct appearance ?
```

---

## State Diagram

```
                        ????????????????????????
                        ?  Window.OnOpened()   ?
                        ????????????????????????
                                   ?
                    ???????????????????????????????
                    ? Calculate Virtual Bounds   ?
                    ???????????????????????????????
                                   ?
          ???????????????????????????????????????????????????
          ?                        ?                        ?
          ?                        ?                        ?
    minX = MaxValue        minY = MaxValue        Loop through
    maxX = MinValue        maxY = MinValue        each monitor
          ?                        ?                        ?
          ???????????????????????????????????????????????????
                                   ?
                    ???????????????????????????????
                    ? Store in Private Members   ?
                    ? _virtualScreenX, Y, W, H   ?
                    ???????????????????????????????
                                   ?
                    ???????????????????????????????
                    ? Set Window Position/Size   ?
                    ? (Logical units)            ?
                    ???????????????????????????????
                                   ?
          ???????????????????????????????????????????????
          ?                                             ?
          ?                                             ?
   [User Moves Mouse]                        [Window Rendered]
          ?                                             ?
          ?                                             ?
   [OnPointerMoved]                                    ?
          ?                                             ?
   ??????????????????????????????????????????????????? ?
   ? Get Global Physical Coords (GetCursorPos)       ? ?
   ? Convert to Logical: (global - offset) / scale   ? ?
   ? Clamp to bounds                                 ? ?
   ? Draw selection rectangle                        ? ?
   ???????????????????????????????????????????????????? ?
          ?                                             ?
          ?                                             ?
   [User Releases Mouse]                              ?
          ?                                             ?
          ?                                             ?
   [OnPointerReleased]                                ?
          ?                                             ?
   ??????????????????????????????????????????????????? ?
   ? Calculate in Global Physical Coords             ? ?
   ? Return Rectangle(globalX, globalY, W, H)        ? ?
   ???????????????????????????????????????????????????? ?
          ?                                             ?
          ?                                             ?
   [Pass to CopyFromScreen]                           ?
          ?                                             ?
          ?                                             ?
   [Capture Complete] ?                               ?
                                                       ?
                                   ?????????????????????
                                   ?
                                   ?
                        [Window Closed]
```

---

## Summary

The fix implements a **3-level coordinate transformation** system:

1. **Level 1 (Input)**: Global Physical Coordinates from OS
2. **Level 2 (Processing)**: Logical Coordinates for rendering
3. **Level 3 (Output)**: Global Physical Coordinates for capture

This ensures:
- ? Negative coordinates handled correctly
- ? DPI scaling properly applied
- ? No double-scaling artifacts
- ? 1:1 pixel-perfect mapping
- ? Multi-monitor support
