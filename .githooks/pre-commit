#!/bin/bash
#
# Pre-commit hook to validate GPL v3 license headers in C# files
# This hook checks all staged .cs files for proper license headers
#
# To install: git config core.hooksPath .githooks
# To bypass: git commit --no-verify
#

set -e

# Colors for output
RED='\033[0;31m'
YELLOW='\033[1;33m'
GREEN='\033[0;32m'
NC='\033[0m' # No Color

# Expected header components
CURRENT_YEAR=$(date +%Y)
EXPECTED_PROJECT="XerahS - The Avalonia UI implementation of ShareX"
EXPECTED_COPYRIGHT="Copyright (c) 2007-$CURRENT_YEAR ShareX Team"
EXPECTED_GPL_START="This program is free software"

# Get list of staged C# files
STAGED_CS_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep '\.cs$' || true)

if [ -z "$STAGED_CS_FILES" ]; then
    echo -e "${GREEN}✓ No C# files to check${NC}"
    exit 0
fi

echo "Checking license headers in staged C# files..."

VIOLATIONS=0
VIOLATION_FILES=()

for FILE in $STAGED_CS_FILES; do
    if [ ! -f "$FILE" ]; then
        continue
    fi

    # Read first 30 lines (header should be within this)
    HEADER=$(head -n 30 "$FILE")

    # Check for required components
    MISSING=()

    if ! echo "$HEADER" | grep -q "$EXPECTED_PROJECT"; then
        MISSING+=("project name")
    fi

    if ! echo "$HEADER" | grep -q "$EXPECTED_COPYRIGHT"; then
        MISSING+=("copyright year $CURRENT_YEAR")
    fi

    if ! echo "$HEADER" | grep -q "$EXPECTED_GPL_START"; then
        MISSING+=("GPL v3 license text")
    fi

    # Check if header is before any code (should be after #region License Information)
    if ! echo "$HEADER" | grep -q "#region License Information"; then
        MISSING+=("#region License Information tag")
    fi

    if [ ${#MISSING[@]} -gt 0 ]; then
        VIOLATIONS=$((VIOLATIONS + 1))
        VIOLATION_FILES+=("$FILE")
        echo -e "${RED}✗ $FILE${NC}"
        echo -e "  Missing: ${MISSING[*]}"
    fi
done

if [ $VIOLATIONS -gt 0 ]; then
    echo ""
    echo -e "${RED}════════════════════════════════════════════════════════════${NC}"
    echo -e "${RED}  LICENSE HEADER VALIDATION FAILED${NC}"
    echo -e "${RED}════════════════════════════════════════════════════════════${NC}"
    echo ""
    echo -e "${YELLOW}$VIOLATIONS file(s) have incorrect or missing license headers:${NC}"
    for FILE in "${VIOLATION_FILES[@]}"; do
        echo -e "  ${YELLOW}→${NC} $FILE"
    done
    echo ""
    echo -e "${YELLOW}Expected header format:${NC}"
    echo "  #region License Information (GPL v3)"
    echo "  /*"
    echo "      $EXPECTED_PROJECT"
    echo "      $EXPECTED_COPYRIGHT"
    echo ""
    echo "      This program is free software; you can redistribute it and/or"
    echo "      modify it under the terms of the GNU General Public License"
    echo "      ..."
    echo "  */"
    echo "  #endregion License Information (GPL v3)"
    echo ""
    echo -e "${YELLOW}To fix:${NC}"
    echo "  1. Update headers manually, or"
    echo "  2. Run: pwsh docs/scripts/fix_license_headers.ps1"
    echo "  3. Re-stage files: git add <files>"
    echo ""
    echo -e "${YELLOW}To bypass this check (NOT RECOMMENDED):${NC}"
    echo "  git commit --no-verify"
    echo ""
    exit 1
fi

echo -e "${GREEN}✓ All staged C# files have valid license headers ($(($(echo "$STAGED_CS_FILES" | wc -l))) files checked)${NC}"
exit 0
