<Project>
  <!-- Import parent Directory.Build.props -->
  <Import Project="$([MSBuild]::GetPathOfFileAbove('Directory.Build.props', '$(MSBuildThisFileDirectory)..'))" />

  <PropertyGroup>
    <Version>0.15.3</Version>
  </PropertyGroup>

  <PropertyGroup>
    <!-- Plugins are libraries, not executables - disable single-file publishing -->
    <!-- This prevents NETSDK1099 when main app publishes with PublishSingleFile=true -->
    <PublishSingleFile>false</PublishSingleFile>
  </PropertyGroup>

  <!-- Copy plugin to main app's Plugins directory (only when built standalone, not during Publish) -->
  <Target Name="CopyToPluginsDir" AfterTargets="Build" Condition="!$(OutputPath.Contains('Plugins'))">
    <PropertyGroup>
      <!-- Use the host app's TFM when passed from BuildPlugins, otherwise fall back to plugin's own TFM -->
      <_AppTargetFramework Condition="'$(HostTargetFramework)' != ''">$(HostTargetFramework)</_AppTargetFramework>
      <_AppTargetFramework Condition="'$(HostTargetFramework)' == ''">$(TargetFramework)</_AppTargetFramework>
      <PluginOutputDir>$(MSBuildThisFileDirectory)..\app\XerahS.App\bin\$(Configuration)\$(_AppTargetFramework)\Plugins\$(PluginId)</PluginOutputDir>
    </PropertyGroup>
    <ItemGroup>
      <PluginFiles Include="$(OutputPath)$(AssemblyName).dll" />
      <PluginFiles Include="$(OutputPath)$(AssemblyName).pdb" Condition="Exists('$(OutputPath)$(AssemblyName).pdb')" />
      <PluginFiles Include="$(OutputPath)plugin.json" Condition="Exists('$(OutputPath)plugin.json')" />
      <!-- Include any additional runtime dependencies that aren't from the host -->
      <PluginFiles Include="$(OutputPath)*.dll" Exclude="$(OutputPath)$(AssemblyName).dll;$(OutputPath)Avalonia*.dll;$(OutputPath)XerahS.*.dll;$(OutputPath)CommunityToolkit*.dll;$(OutputPath)Newtonsoft*.dll" />
    </ItemGroup>
    <MakeDir Directories="$(PluginOutputDir)" Condition="!Exists('$(PluginOutputDir)')" />
    <Copy SourceFiles="@(PluginFiles)" DestinationFolder="$(PluginOutputDir)" SkipUnchangedFiles="true" />
    <Message Importance="High" Text="Copied $(PluginName) plugin to: $(PluginOutputDir)" />
  </Target>
</Project>
