<UserControl xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             xmlns:vm="using:XerahS.UI.ViewModels"
             xmlns:views="using:XerahS.UI.Views"
             xmlns:controls="using:XerahS.UI.Controls"
             mc:Ignorable="d" d:DesignWidth="800" d:DesignHeight="800"
             x:Class="XerahS.UI.Views.TaskSettingsPanel"
             x:DataType="vm:TaskSettingsViewModel">

    <Design.DataContext>
        <vm:TaskSettingsViewModel/>
    </Design.DataContext>

    <Grid RowDefinitions="*" Margin="0" HorizontalAlignment="Stretch" VerticalAlignment="Stretch">
        <TabControl Grid.Row="0" HorizontalAlignment="Stretch" VerticalAlignment="Stretch" MinHeight="300">
            
            <!-- Capture Tab -->
            <TabItem Header="Capture">
                <ScrollViewer Padding="20">
                    <StackPanel Spacing="24">
                        <!-- General Capture Settings -->
                        <StackPanel Spacing="8">
                            <TextBlock Text="General" FontWeight="SemiBold"/>
                            <Border BorderBrush="{DynamicResource SystemControlForegroundBaseLowBrush}" BorderThickness="1" CornerRadius="4" Padding="16">
                                <StackPanel Spacing="16">
                                    <CheckBox IsChecked="{Binding UseModernCapture}" Content="Use modern screen capture (Direct3D11)"/>
                                    <CheckBox IsChecked="{Binding ShowCursor}" Content="Show cursor in screenshots"/>
                                    
                                    <Grid ColumnDefinitions="Auto, 16, *" RowDefinitions="Auto, Auto, Auto">
                                        <!-- Screenshot Delay -->
                                        <TextBlock Grid.Row="0" Grid.Column="0" Text="Screenshot delay:" VerticalAlignment="Center"/>
                                        <StackPanel Grid.Row="0" Grid.Column="2" Orientation="Horizontal" Spacing="8">
                                            <NumericUpDown Value="{Binding ScreenshotDelay}" Minimum="0" Maximum="60" Increment="0.1" FormatString="0.0" Width="120" AutomationProperties.Name="Screenshot Delay"/>
                                            <TextBlock Text="seconds" VerticalAlignment="Center"/>
                                        </StackPanel>

                                        <!-- Window Title -->
                                        <TextBlock Grid.Row="1" Grid.Column="0" Text="Window title:" VerticalAlignment="Center" Margin="0,16,0,0"/>
                                        <TextBox Grid.Row="1" Grid.Column="2" Text="{Binding CaptureCustomWindow, UpdateSourceTrigger=PropertyChanged}" 
                                                 Watermark="Window title to capture (CustomWindow job)" Margin="0,16,0,0" AutomationProperties.Name="Window Title"/>
                                    </Grid>

                                    <StackPanel Spacing="10">
                                        <CheckBox IsChecked="{Binding CaptureTransparent}" Content="Capture transparency"/>
                                        <CheckBox IsChecked="{Binding CaptureShadow}" Content="Capture window shadow" IsEnabled="{Binding CaptureTransparent}" Margin="24,0,0,0"/>
                                        <CheckBox IsChecked="{Binding CaptureClientArea}" Content="Capture client area (remove window chrome)"/>
                                        <CheckBox IsChecked="{Binding CaptureAutoHideTaskbar}" Content="Auto hide taskbar during capture"/>
                                    </StackPanel>
                                </StackPanel>
                            </Border>
                        </StackPanel>

                        <!-- After Capture Tasks Section -->
                        <StackPanel Spacing="8">
                            <TextBlock Text="After capture" FontWeight="SemiBold"/>
                            <Border BorderBrush="{DynamicResource SystemControlForegroundBaseLowBrush}" BorderThickness="1" CornerRadius="4" Padding="16">
                                <StackPanel Spacing="12">
                                    <TextBlock Text="Choose actions to perform automatically after capturing" 
                                               FontSize="12" 
                                               Foreground="{DynamicResource SystemControlForegroundBaseMediumBrush}" 
                                               Margin="0,0,0,4"/>
                                    
                                    <CheckBox IsChecked="{Binding SaveImageToFile}" Content="Save image to file"/>
                                    <CheckBox IsChecked="{Binding CopyImageToClipboard}" Content="Copy image to clipboard"/>
                                    <CheckBox IsChecked="{Binding UploadImageToHost}" Content="Upload image to host" FontWeight="SemiBold"/>
                                    <CheckBox IsChecked="{Binding ApplyImageEffects}" Content="Apply image effects"/>
                                    <CheckBox IsChecked="{Binding AnnotateImage}" Content="Annotate image"/>
                                    <CheckBox IsChecked="{Binding ShowAfterCaptureWindow}" Content="Show after capture window"/>
                                </StackPanel>
                            </Border>
                        </StackPanel>
                    </StackPanel>
                </ScrollViewer>
            </TabItem>

            <!-- Index Folder Tab (Conditional) -->
            <TabItem Header="Index Folder" IsVisible="{Binding IsIndexFolderJob}">
                <ScrollViewer Padding="20">
                     <StackPanel Spacing="8">
                        <TextBlock Text="Index folder" FontWeight="SemiBold"/>
                        <Border BorderBrush="{DynamicResource SystemControlForegroundBaseLowBrush}" BorderThickness="1" CornerRadius="4" Padding="16">
                            <StackPanel Spacing="16">
                                <Grid ColumnDefinitions="Auto, 16, *, Auto">
                                    <TextBlock Grid.Column="0" Text="Folder:" VerticalAlignment="Center"/>
                                    <TextBox Grid.Column="2" Text="{Binding IndexerFolderPath}" Watermark="Folder to index" AutomationProperties.Name="Indexer Folder"/>
                                    <Button Grid.Column="3" Content="Browse..." Command="{Binding BrowseIndexerFolderCommand}" Margin="16,0,0,0"/>
                                </Grid>

                                <Grid ColumnDefinitions="Auto, 16, *">
                                    <TextBlock Grid.Column="0" Text="Output:" VerticalAlignment="Center"/>
                                    <ComboBox Grid.Column="2" ItemsSource="{Binding IndexerOutputs}" SelectedItem="{Binding IndexerOutput}" Width="200" HorizontalAlignment="Left" AutomationProperties.Name="Indexer Output Format"/>
                                </Grid>

                                <Grid ColumnDefinitions="Auto, 16, *">
                                    <TextBlock Grid.Column="0" Text="Max depth:" VerticalAlignment="Center"/>
                                    <NumericUpDown Grid.Column="2" Value="{Binding IndexerMaxDepthLevel}" Minimum="0" Maximum="50" Width="120" HorizontalAlignment="Left" AutomationProperties.Name="Max Depth Level"/>
                                </Grid>

                                <StackPanel Spacing="10">
                                    <CheckBox IsChecked="{Binding IndexerSkipHiddenFolders}" Content="Skip hidden folders"/>
                                    <CheckBox IsChecked="{Binding IndexerSkipHiddenFiles}" Content="Skip hidden files"/>
                                    <CheckBox IsChecked="{Binding IndexerSkipFiles}" Content="Skip files"/>
                                    <CheckBox IsChecked="{Binding IndexerShowSizeInfo}" Content="Show size info"/>
                                    <CheckBox IsChecked="{Binding IndexerAddFooter}" Content="Add footer"/>
                                </StackPanel>

                                <Grid ColumnDefinitions="Auto, 16, *">
                                    <TextBlock Grid.Column="0" Text="Indentation:" VerticalAlignment="Center"/>
                                    <TextBox Grid.Column="2" Text="{Binding IndexerIndentationText}" Width="200" HorizontalAlignment="Left" AutomationProperties.Name="Indentation Text"/>
                                </Grid>

                                <CheckBox IsChecked="{Binding IndexerAddEmptyLineAfterFolders}" Content="Add empty line after folders"/>

                                <Separator Background="{DynamicResource SystemControlForegroundBaseLowBrush}" Height="1"/>
                                
                                <TextBlock Text="HTML options" FontWeight="SemiBold" FontSize="12"/>
                                <CheckBox IsChecked="{Binding IndexerUseCustomCssFile}" Content="Use custom CSS file"/>
                                
                                <Grid ColumnDefinitions="Auto, 16, *, Auto" IsEnabled="{Binding IndexerUseCustomCssFile}">
                                    <TextBlock Grid.Column="0" Text="CSS path:" VerticalAlignment="Center"/>
                                    <TextBox Grid.Column="2" Text="{Binding IndexerCustomCssFilePath}" AutomationProperties.Name="CSS File Path"/>
                                    <Button Grid.Column="3" Content="Browse..." Command="{Binding BrowseIndexerCssFileCommand}" Margin="16,0,0,0"/>
                                </Grid>
                                
                                <CheckBox IsChecked="{Binding IndexerDisplayPath}" Content="Display path for subfolders"/>
                                <CheckBox IsChecked="{Binding IndexerDisplayPathLimited}"
                                          Content="Limit display path to root folder"
                                          IsEnabled="{Binding IndexerDisplayPath}"
                                          Margin="24,0,0,0"/>

                                <Separator Background="{DynamicResource SystemControlForegroundBaseLowBrush}" Height="1"/>
                                
                                <TextBlock Text="XML / JSON options" FontWeight="SemiBold" FontSize="12"/>
                                <StackPanel Spacing="10">
                                    <CheckBox IsChecked="{Binding IndexerUseAttribute}" Content="Write file info as attribute (XML)"/>
                                    <CheckBox IsChecked="{Binding IndexerCreateParseableJson}" Content="Create parseable JSON"/>
                                    <CheckBox IsChecked="{Binding IndexerBinaryUnits}" Content="Use binary units for size"/>
                                </StackPanel>
                            </StackPanel>
                        </Border>
                    </StackPanel>
                </ScrollViewer>
            </TabItem>

            <!-- File Tab (New) -->
            <TabItem Header="File">
                <ScrollViewer Padding="20">
                     <StackPanel Spacing="8">
                        <TextBlock Text="File naming" FontWeight="SemiBold"/>
                        <Border BorderBrush="{DynamicResource SystemControlForegroundBaseLowBrush}" BorderThickness="1" CornerRadius="4" Padding="16">
                            <StackPanel Spacing="16">
                                <Grid ColumnDefinitions="Auto, 16, *">
                                    <TextBlock Grid.Column="0" Text="Name pattern:" VerticalAlignment="Center"/>
                                    <TextBox Grid.Column="2" Text="{Binding NameFormatPattern, Mode=TwoWay}" AutomationProperties.Name="Name Pattern"/>
                                </Grid>
                                <Grid ColumnDefinitions="Auto, 16, *">
                                    <TextBlock Grid.Column="0" Text="Active window name pattern:" VerticalAlignment="Center"/>
                                    <TextBox Grid.Column="2" Text="{Binding NameFormatPatternActiveWindow, Mode=TwoWay}" AutomationProperties.Name="Active Window Name Pattern"/>
                                </Grid>
                                
                                <StackPanel Spacing="10">
                                    <CheckBox IsChecked="{Binding FileUploadUseNamePattern}" Content="Use name pattern for file uploaders"/>
                                    <CheckBox IsChecked="{Binding FileUploadReplaceProblematicCharacters}" Content="Replace potentially problematic characters"/>
                                    <CheckBox IsChecked="{Binding URLRegexReplace}" Content="Perform regex replace on URL"/>
                                </StackPanel>
                                
                                <Grid ColumnDefinitions="Auto, 16, *" RowDefinitions="Auto, 16, Auto" IsVisible="{Binding URLRegexReplace}">
                                    <TextBlock Grid.Row="0" Grid.Column="0" Text="Regex pattern:" VerticalAlignment="Center"/>
                                    <TextBox Grid.Row="0" Grid.Column="2" Text="{Binding URLRegexReplacePattern, Mode=TwoWay}" AutomationProperties.Name="URL Regex Pattern"/>
                                    
                                    <TextBlock Grid.Row="2" Grid.Column="0" Text="Replacement:" VerticalAlignment="Center"/>
                                    <TextBox Grid.Row="2" Grid.Column="2" Text="{Binding URLRegexReplaceReplacement, Mode=TwoWay}" AutomationProperties.Name="URL Regex Replacement"/>
                                </Grid>
                            </StackPanel>
                        </Border>
                    </StackPanel>
                </ScrollViewer>
            </TabItem>

            <!-- Upload Tab -->
            <TabItem Header="Upload">
               <ScrollViewer Padding="20">
                   <StackPanel Spacing="24">
                        <!-- Destinations Section (New) -->
                        <StackPanel Spacing="8">
                            <TextBlock Text="Destinations" FontWeight="SemiBold"/>
                            <Border BorderBrush="{DynamicResource SystemControlForegroundBaseLowBrush}" BorderThickness="1" CornerRadius="4" Padding="16">
                                <StackPanel Spacing="16">
                                    <TextBlock Text="Select the destination for this task:" VerticalAlignment="Center"/>
                                    <ComboBox ItemsSource="{Binding DataContext.AvailableDestinations, RelativeSource={RelativeSource AncestorType={x:Type views:WorkflowEditorView}}}"
                                              SelectedItem="{Binding DataContext.SelectedDestination, RelativeSource={RelativeSource AncestorType={x:Type views:WorkflowEditorView}}}"
                                              HorizontalAlignment="Stretch"
                                              AutomationProperties.Name="Select Destination">
                                        <ComboBox.ItemTemplate>
                                            <DataTemplate>
                                                 <StackPanel Orientation="Horizontal" Spacing="8">
                                                     <Image Source="{Binding Icon}" Width="16" Height="16"/>
                                                     <TextBlock Text="{Binding DisplayName}" VerticalAlignment="Center"/>
                                                 </StackPanel>
                                            </DataTemplate>
                                        </ComboBox.ItemTemplate>
                                    </ComboBox>
                                </StackPanel>
                            </Border>
                        </StackPanel>

                        <!-- Clipboard Upload -->
                        <StackPanel Spacing="8">
                            <TextBlock Text="Clipboard upload" FontWeight="SemiBold"/>
                            <Border BorderBrush="{DynamicResource SystemControlForegroundBaseLowBrush}" BorderThickness="1" CornerRadius="4" Padding="16">
                                <StackPanel Spacing="10">
                                    <CheckBox IsChecked="{Binding ClipboardUploadURLContents}" Content="Upload URL contents"/>
                                    <CheckBox IsChecked="{Binding ClipboardUploadShortenURL}" Content="Shorten URL"/>
                                </StackPanel>
                            </Border>
                        </StackPanel>

                        <!-- After Upload Tasks -->
                        <StackPanel Spacing="8">
                            <TextBlock Text="After upload" FontWeight="SemiBold"/>
                            <Border BorderBrush="{DynamicResource SystemControlForegroundBaseLowBrush}" BorderThickness="1" CornerRadius="4" Padding="16">
                                <StackPanel Spacing="12">
                                    <TextBlock Text="Choose actions to perform automatically after upload" 
                                               FontSize="12" 
                                               Foreground="{DynamicResource SystemControlForegroundBaseMediumBrush}" 
                                               Margin="0,0,0,4"/>
                                    <CheckBox IsChecked="{Binding ShowAfterUploadWindow}" 
                                              Content="Show after upload window"
                                              AutomationProperties.Name="Show After Upload Window"/>
                                    <CheckBox IsChecked="{Binding CopyURLToClipboard}" 
                                              Content="Copy URL to clipboard"/>
                                    <CheckBox IsChecked="{Binding UseURLShortener}" 
                                              Content="Use URL shortener"/>
                                    <CheckBox IsChecked="{Binding ShareURL}" 
                                              Content="Share URL"/>
                                </StackPanel>
                            </Border>
                        </StackPanel>
                   </StackPanel>
               </ScrollViewer>
            </TabItem>

            <!-- Notifications Tab (Renamed from General) -->
            <TabItem Header="Notifications">
                <ScrollViewer Padding="20">
                    <StackPanel Spacing="24">
                        <!-- Notifications Section -->
                        <StackPanel Spacing="8">
                            <TextBlock Text="Notifications" FontWeight="SemiBold"/>
                            <Border BorderBrush="{DynamicResource SystemControlForegroundBaseLowBrush}" BorderThickness="1" CornerRadius="4" Padding="16">
                                <StackPanel Spacing="16">
                                    <StackPanel Spacing="10">
                                        <CheckBox IsChecked="{Binding PlaySoundAfterCapture}" Content="Play sound after capture"/>
                                        <CheckBox IsChecked="{Binding PlaySoundAfterUpload}" Content="Play sound after upload"/>
                                        <CheckBox IsChecked="{Binding PlaySoundAfterAction}" Content="Play sound after action"/>
                                        <CheckBox IsChecked="{Binding ShowToastNotification}" Content="Include toast notification"/>
                                    </StackPanel>
                                    
                                    <!-- Toast Settings -->
                                    <Grid ColumnDefinitions="Auto, 16, *" RowDefinitions="Auto, Auto, Auto, Auto, Auto, Auto" 
                                          IsVisible="{Binding ShowToastNotification}" Margin="24,0,0,0">
                                        
                                        <!-- Duration -->
                                        <TextBlock Grid.Row="0" Grid.Column="0" Text="Duration:" VerticalAlignment="Center"/>
                                        <StackPanel Grid.Row="0" Grid.Column="2" Orientation="Horizontal" Spacing="8">
                                            <NumericUpDown Value="{Binding ToastWindowDuration}" Minimum="0.5" Maximum="30" Increment="0.5" FormatString="0.0" Width="120" AutomationProperties.Name="Toast Duration"/>
                                            <TextBlock Text="seconds" VerticalAlignment="Center"/>
                                        </StackPanel>

                                        <!-- Fade Duration -->
                                        <TextBlock Grid.Row="1" Grid.Column="0" Text="Fade duration:" VerticalAlignment="Center" Margin="0,8,0,0"/>
                                        <StackPanel Grid.Row="1" Grid.Column="2" Orientation="Horizontal" Spacing="8" Margin="0,8,0,0">
                                            <NumericUpDown Value="{Binding ToastWindowFadeDuration}" Minimum="0" Maximum="5" Increment="0.1" FormatString="0.0" Width="120" AutomationProperties.Name="Toast Fade Duration"/>
                                            <TextBlock Text="seconds" VerticalAlignment="Center"/>
                                        </StackPanel>

                                        <!-- Placement -->
                                        <TextBlock Grid.Row="2" Grid.Column="0" Text="Placement:" VerticalAlignment="Center" Margin="0,8,0,0"/>
                                        <ComboBox Grid.Row="2" Grid.Column="2" ItemsSource="{Binding ContentAlignments}" SelectedItem="{Binding ToastWindowPlacement}" HorizontalAlignment="Left" Width="200" Margin="0,8,0,0" AutomationProperties.Name="Toast Placement"/>

                                        <!-- Size -->
                                        <TextBlock Grid.Row="3" Grid.Column="0" Text="Size:" VerticalAlignment="Center" Margin="0,8,0,0"/>
                                        <StackPanel Grid.Row="3" Grid.Column="2" Orientation="Horizontal" Spacing="8" Margin="0,8,0,0">
                                            <NumericUpDown Value="{Binding ToastWindowWidth}" Minimum="100" Maximum="2000" Increment="10" Width="120" AutomationProperties.Name="Toast Width"/>
                                            <TextBlock Text="x" VerticalAlignment="Center"/>
                                            <NumericUpDown Value="{Binding ToastWindowHeight}" Minimum="50" Maximum="1000" Increment="10" Width="120" AutomationProperties.Name="Toast Height"/>
                                        </StackPanel>
                                        
                                        <!-- Auto Hide -->
                                         <CheckBox Grid.Row="4" Grid.Column="0" Grid.ColumnSpan="3" IsChecked="{Binding ToastWindowAutoHide}" Content="Auto hide toast notification" Margin="0,8,0,0"/>

                                        <!-- Click Actions -->
                                        <Grid Grid.Row="5" Grid.Column="0" Grid.ColumnSpan="3" ColumnDefinitions="Auto, 16, *" RowDefinitions="Auto, Auto, Auto" Margin="0,16,0,0">
                                            <TextBlock Grid.Row="0" Grid.Column="0" Text="Left click:" VerticalAlignment="Center"/>
                                            <ComboBox Grid.Row="0" Grid.Column="2" ItemsSource="{Binding ToastClickActions}" SelectedItem="{Binding ToastWindowLeftClickAction}" HorizontalAlignment="Stretch" AutomationProperties.Name="Left Click Action"/>

                                            <TextBlock Grid.Row="1" Grid.Column="0" Text="Middle click:" VerticalAlignment="Center" Margin="0,8,0,0"/>
                                            <ComboBox Grid.Row="1" Grid.Column="2" ItemsSource="{Binding ToastClickActions}" SelectedItem="{Binding ToastWindowMiddleClickAction}" HorizontalAlignment="Stretch" Margin="0,8,0,0" AutomationProperties.Name="Middle Click Action"/>

                                            <TextBlock Grid.Row="2" Grid.Column="0" Text="Right click:" VerticalAlignment="Center" Margin="0,8,0,0"/>
                                            <ComboBox Grid.Row="2" Grid.Column="2" ItemsSource="{Binding ToastClickActions}" SelectedItem="{Binding ToastWindowRightClickAction}" HorizontalAlignment="Stretch" Margin="0,8,0,0" AutomationProperties.Name="Right Click Action"/>
                                        </Grid>
                                    </Grid>
                                </StackPanel>
                            </Border>
                        </StackPanel>

                        <!-- Sound Section -->
                        <StackPanel Spacing="8">
                            <TextBlock Text="Sound" FontWeight="SemiBold"/>
                            <Border BorderBrush="{DynamicResource SystemControlForegroundBaseLowBrush}" BorderThickness="1" CornerRadius="4" Padding="16">
                                <StackPanel Spacing="16">
                                    <CheckBox IsChecked="{Binding UseCustomCaptureSound}" Content="Use custom capture sound"/>
                                    <Grid ColumnDefinitions="Auto, 16, *" IsVisible="{Binding UseCustomCaptureSound}">
                                        <TextBlock Grid.Column="0" Text="Path:" VerticalAlignment="Center"/>
                                        <TextBox Grid.Column="2" Text="{Binding CustomCaptureSoundPath}" AutomationProperties.Name="Sound File Path"/>
                                    </Grid>
                                </StackPanel>
                            </Border>
                        </StackPanel>
                    </StackPanel>
                </ScrollViewer>
            </TabItem>

            <!-- Advanced Tab -->
            <TabItem Header="Advanced">
                <Grid Margin="24" RowDefinitions="Auto, *">
                    <TextBlock Grid.Row="0"
                               Text="Advanced Properties"
                                FontWeight="SemiBold"
                                Margin="0,0,0,12"/>
                    <Border Grid.Row="1"
                            BorderThickness="1"
                            BorderBrush="{DynamicResource SystemControlForegroundBaseLowBrush}"
                            CornerRadius="4"
                            Padding="8">
                        <controls:PropertyGrid SelectedObject="{Binding AdvancedSettings}"
                                               AutomationProperties.Name="Advanced Task Settings"/>
                    </Border>
                </Grid>
            </TabItem>

        </TabControl>
    </Grid>
</UserControl>
