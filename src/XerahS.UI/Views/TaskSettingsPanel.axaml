<UserControl xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             xmlns:vm="using:XerahS.UI.ViewModels"
             xmlns:controls="using:XerahS.UI.Controls"
             mc:Ignorable="d" d:DesignWidth="800" d:DesignHeight="450"
             x:Class="XerahS.UI.Views.TaskSettingsPanel"
             x:DataType="vm:TaskSettingsViewModel">

    <Design.DataContext>
        <vm:SettingsViewModel/>
    </Design.DataContext>

    <Grid RowDefinitions="*" Margin="0" HorizontalAlignment="Stretch" VerticalAlignment="Stretch">
        <TabControl Grid.Row="0" HorizontalAlignment="Stretch" VerticalAlignment="Stretch" MinHeight="300">
            <!-- General Tab -->
            <TabItem Header="General">
                <ScrollViewer>
                    <StackPanel Margin="20" Spacing="20">
                        <StackPanel Spacing="10">
                            <TextBlock Text="Notifications" FontWeight="SemiBold"/>
                            <Border BorderBrush="{DynamicResource SystemControlForegroundBaseLowBrush}" BorderThickness="1" CornerRadius="4" Padding="10">
                                <StackPanel Spacing="10">
                                    <CheckBox IsChecked="{Binding PlaySoundAfterCapture}" Content="Play sound after capture"/>
                                    <CheckBox IsChecked="{Binding PlaySoundAfterUpload}" Content="Play sound after upload"/>
                                    <CheckBox IsChecked="{Binding PlaySoundAfterAction}" Content="Play sound after action"/>
                                    <CheckBox IsChecked="{Binding ShowToastNotification}" Content="Show toast notification after task completed"/>
                                    
                                    <!-- Toast Settings -->
                                    <StackPanel Spacing="10" Margin="20,0,0,0" IsVisible="{Binding ShowToastNotification}">
                                        <Grid ColumnDefinitions="Auto, 10, Auto, 10, Auto, 20, Auto, 10, Auto, 10, Auto">
                                             <TextBlock Grid.Column="0" Text="Duration:" VerticalAlignment="Center"/>
                                             <NumericUpDown Grid.Column="2" Value="{Binding ToastWindowDuration}" Minimum="0.5" Maximum="30" Increment="0.5" FormatString="0.0" Width="80"/>
                                             <TextBlock Grid.Column="4" Text="seconds" VerticalAlignment="Center"/>
                                            
                                             <TextBlock Grid.Column="6" Text="Fade duration:" VerticalAlignment="Center"/>
                                             <NumericUpDown Grid.Column="8" Value="{Binding ToastWindowFadeDuration}" Minimum="0" Maximum="5" Increment="0.1" FormatString="0.0" Width="80"/>
                                             <TextBlock Grid.Column="10" Text="seconds" VerticalAlignment="Center"/>
                                        </Grid>

                                        <CheckBox IsChecked="{Binding ToastWindowAutoHide}" Content="Auto hide toast notification"/>

                                        <Grid ColumnDefinitions="Auto, 10, *, 20, Auto, 10, Auto, 5, Auto, 5, Auto">
                                            <TextBlock Grid.Column="0" Text="Placement:" VerticalAlignment="Center"/>
                                            <ComboBox Grid.Column="2" ItemsSource="{Binding ContentAlignments}" SelectedItem="{Binding ToastWindowPlacement}" HorizontalAlignment="Stretch"/>
                                            
                                            <TextBlock Grid.Column="4" Text="Size:" VerticalAlignment="Center"/>
                                            <NumericUpDown Grid.Column="6" Value="{Binding ToastWindowWidth}" Minimum="100" Maximum="2000" Increment="10" Width="80"/>
                                            <TextBlock Grid.Column="8" Text="x" VerticalAlignment="Center"/>
                                            <NumericUpDown Grid.Column="10" Value="{Binding ToastWindowHeight}" Minimum="50" Maximum="1000" Increment="10" Width="80"/>
                                        </Grid>

                                        <Grid ColumnDefinitions="Auto, 10, *">
                                            <TextBlock Grid.Column="0" Text="Left click action:" VerticalAlignment="Center"/>
                                            <ComboBox Grid.Column="2" ItemsSource="{Binding ToastClickActions}" SelectedItem="{Binding ToastWindowLeftClickAction}" HorizontalAlignment="Stretch"/>
                                        </Grid>

                                        <Grid ColumnDefinitions="Auto, 10, *">
                                            <TextBlock Grid.Column="0" Text="Middle click action:" VerticalAlignment="Center"/>
                                            <ComboBox Grid.Column="2" ItemsSource="{Binding ToastClickActions}" SelectedItem="{Binding ToastWindowMiddleClickAction}" HorizontalAlignment="Stretch"/>
                                        </Grid>

                                        <Grid ColumnDefinitions="Auto, 10, *">
                                            <TextBlock Grid.Column="0" Text="Right click action:" VerticalAlignment="Center"/>
                                            <ComboBox Grid.Column="2" ItemsSource="{Binding ToastClickActions}" SelectedItem="{Binding ToastWindowRightClickAction}" HorizontalAlignment="Stretch"/>
                                        </Grid>
                                    </StackPanel>
                                </StackPanel>
                            </Border>
                        </StackPanel>

                        <StackPanel Spacing="10">
                            <TextBlock Text="Sound" FontWeight="SemiBold"/>
                            <Border BorderBrush="{DynamicResource SystemControlForegroundBaseLowBrush}" BorderThickness="1" CornerRadius="4" Padding="10">
                                <StackPanel Spacing="10">
                                    <CheckBox IsChecked="{Binding UseCustomCaptureSound}" Content="Use custom capture sound"/>
                                    <Grid ColumnDefinitions="Auto, 10, *" IsVisible="{Binding UseCustomCaptureSound}">
                                        <TextBlock Grid.Column="0" Text="Path:" VerticalAlignment="Center"/>
                                        <TextBox Grid.Column="2" Text="{Binding CustomCaptureSoundPath}"/>
                                    </Grid>
                                </StackPanel>
                            </Border>
                        </StackPanel>
                    </StackPanel>
                </ScrollViewer>
            </TabItem>


            <!-- Capture Tab -->
            <TabItem Header="Capture">
                <ScrollViewer>
                    <StackPanel Margin="20" Spacing="20">
                        <StackPanel Spacing="10">
                            <TextBlock Text="General" FontWeight="SemiBold"/>
                            <Border BorderBrush="{DynamicResource SystemControlForegroundBaseLowBrush}" BorderThickness="1" CornerRadius="4" Padding="10">
                                <StackPanel Spacing="10">
                                    <CheckBox IsChecked="{Binding UseModernCapture}" Content="Use modern screen capture (Direct3D11)"/>
                                    <CheckBox IsChecked="{Binding ShowCursor}" Content="Show cursor in screenshots"/>
                                    <Grid ColumnDefinitions="Auto, 10, Auto, 10, Auto">
                                         <TextBlock Grid.Column="0" Text="Screenshot delay:" VerticalAlignment="Center"/>
                                         <NumericUpDown Grid.Column="2" Value="{Binding ScreenshotDelay}" Minimum="0" Maximum="60" Increment="0.1" FormatString="0.0" Width="100"/>
                                         <TextBlock Grid.Column="4" Text="seconds" VerticalAlignment="Center"/>
                                    </Grid>
                                    <CheckBox IsChecked="{Binding CaptureTransparent}" Content="Capture transparency"/>
                                    <CheckBox IsChecked="{Binding CaptureShadow}" Content="Capture window shadow" IsEnabled="{Binding CaptureTransparent}" Margin="20,0,0,0"/>
                                    <CheckBox IsChecked="{Binding CaptureClientArea}" Content="Capture client area (remove window chrome)"/>
                                    <CheckBox IsChecked="{Binding CaptureAutoHideTaskbar}" Content="Auto hide taskbar during capture"/>
                                    <Grid ColumnDefinitions="Auto, 10, *">
                                         <TextBlock Grid.Column="0" Text="Window title:" VerticalAlignment="Center"/>
                                         <TextBox Grid.Column="2" Text="{Binding CaptureCustomWindow, UpdateSourceTrigger=PropertyChanged}" Watermark="Window title to capture (CustomWindow job)"/>
                                    </Grid>
                                </StackPanel>
                            </Border>
                        </StackPanel>

                        <StackPanel Spacing="10">
                            <TextBlock Text="Screen recorder" FontWeight="SemiBold"/>
                            <Border BorderBrush="{DynamicResource SystemControlForegroundBaseLowBrush}" BorderThickness="1" CornerRadius="4" Padding="10">
                                <StackPanel Spacing="10">
                                    <Grid ColumnDefinitions="Auto, 10, Auto, 10, Auto">
                                         <TextBlock Grid.Column="0" Text="FPS:" VerticalAlignment="Center"/>
                                         <NumericUpDown Grid.Column="2" Value="{Binding ScreenRecordFPS}" Minimum="1" Maximum="144" Increment="1" Width="100"/>
                                    </Grid>
                                    <Grid ColumnDefinitions="Auto, 10, Auto, 10, Auto">
                                         <TextBlock Grid.Column="0" Text="Duration:" VerticalAlignment="Center"/>
                                         <NumericUpDown Grid.Column="2" Value="{Binding ScreenRecordDuration}" Minimum="0" Maximum="3600" Increment="1" Width="100"/>
                                         <TextBlock Grid.Column="4" Text="seconds (0 to disable)" VerticalAlignment="Center"/>
                                    </Grid>
                                    <Grid ColumnDefinitions="Auto, 10, Auto, 10, Auto">
                                         <TextBlock Grid.Column="0" Text="Start delay:" VerticalAlignment="Center"/>
                                         <NumericUpDown Grid.Column="2" Value="{Binding ScreenRecordStartDelay}" Minimum="0" Maximum="60" Increment="0.1" FormatString="0.0" Width="100"/>
                                         <TextBlock Grid.Column="4" Text="seconds" VerticalAlignment="Center"/>
                                    </Grid>
                                    <Grid ColumnDefinitions="Auto, 10, *">
                                         <TextBlock Grid.Column="0" Text="Recording intent:" VerticalAlignment="Center"/>
                                         <ComboBox Grid.Column="2"
                                                   ItemsSource="{Binding RecordingIntents}"
                                                   SelectedItem="{Binding RecordingIntent}"
                                                   HorizontalAlignment="Stretch"
                                                   MinWidth="150"/>
                                    </Grid>
                                </StackPanel>
                            </Border>
                        </StackPanel>

                        <!-- After Capture Tasks Section -->
                        <StackPanel Spacing="10">
                            <TextBlock Text="After capture" FontWeight="SemiBold"/>
                            <Border BorderBrush="{DynamicResource SystemControlForegroundBaseLowBrush}" BorderThickness="1" CornerRadius="4" Padding="10">
                                <StackPanel Spacing="10">
                                    <TextBlock Text="Choose actions to perform automatically after capturing" 
                                               FontSize="12" 
                                               Foreground="Gray" 
                                               Margin="0,0,0,4"/>
                                    <CheckBox IsChecked="{Binding SaveImageToFile}" 
                                              Content="Save image to file"/>
                                    <CheckBox IsChecked="{Binding CopyImageToClipboard}" 
                                              Content="Copy image to clipboard"/>
                                    <CheckBox IsChecked="{Binding UploadImageToHost}" 
                                              Content="Upload image to host"
                                              FontWeight="SemiBold"/>
                                    <CheckBox IsChecked="{Binding AnnotateImage}" 
                                              Content="Annotate image"/>
                                    <CheckBox IsChecked="{Binding ShowAfterCaptureWindow}" 
                                              Content="Show after capture window"/>
                                </StackPanel>
                            </Border>
                        </StackPanel>
                    </StackPanel>
                </ScrollViewer>
            </TabItem>

            <TabItem Header="Image">
                <Grid RowDefinitions="Auto, *">
                    <StackPanel Grid.Row="0" Margin="10" Spacing="20" Orientation="Horizontal">
                        <StackPanel Spacing="10" MinWidth="200">
                            <TextBlock Text="Quality" FontWeight="SemiBold"/>
                             <Border BorderBrush="{DynamicResource SystemControlForegroundBaseLowBrush}" BorderThickness="1" CornerRadius="4" Padding="10">
                                <StackPanel Spacing="10">
                                    <Grid ColumnDefinitions="Auto, 10, *">
                                        <TextBlock Grid.Column="0" Text="Format:" VerticalAlignment="Center"/>
                                        <ComboBox Grid.Column="2" ItemsSource="{Binding ImageFormats}" SelectedItem="{Binding ImageFormat}" HorizontalAlignment="Stretch"/>
                                    </Grid>
                                    <Grid ColumnDefinitions="Auto, 10, *">
                                        <TextBlock Grid.Column="0" Text="JPEG Quality:" VerticalAlignment="Center"/>
                                        <NumericUpDown Grid.Column="2" Value="{Binding ImageJPEGQuality}" Minimum="0" Maximum="100" Increment="1"/>
                                    </Grid>
                                </StackPanel>
                             </Border>
                        </StackPanel>
                        
                        <StackPanel Spacing="10" MinWidth="200">
                            <TextBlock Text="Thumbnail" FontWeight="SemiBold"/>
                             <Border BorderBrush="{DynamicResource SystemControlForegroundBaseLowBrush}" BorderThickness="1" CornerRadius="4" Padding="10">
                                <StackPanel Spacing="10">
                                    <Grid ColumnDefinitions="Auto, 10, *">
                                        <TextBlock Grid.Column="0" Text="Width:" VerticalAlignment="Center"/>
                                        <NumericUpDown Grid.Column="2" Value="{Binding ThumbnailWidth}" Minimum="0" Maximum="10000" Increment="10"/>
                                    </Grid>
                                    <Grid ColumnDefinitions="Auto, 10, *">
                                        <TextBlock Grid.Column="0" Text="Height:" VerticalAlignment="Center"/>
                                        <NumericUpDown Grid.Column="2" Value="{Binding ThumbnailHeight}" Minimum="0" Maximum="10000" Increment="10"/>
                                    </Grid>
                                    <Grid ColumnDefinitions="Auto, 10, *">
                                        <TextBlock Grid.Column="0" Text="Name:" VerticalAlignment="Center"/>
                                        <TextBox Grid.Column="2" Text="{Binding ThumbnailName}"/>
                                    </Grid>
                                    <CheckBox IsChecked="{Binding ThumbnailCheckSize}" Content="Save thumbnail only if smaller than image"/>
                                </StackPanel>
                             </Border>
                        </StackPanel>
                    </StackPanel>

                    <Grid Grid.Row="1" ColumnDefinitions="*, *, 1.5*, *" Margin="10">
                        <!-- Presets -->
                        <DockPanel Grid.Column="0" Margin="0,0,5,0">
                            <TextBlock Text="Presets:" DockPanel.Dock="Top" Margin="0,0,0,5"/>
                            <StackPanel Orientation="Horizontal" DockPanel.Dock="Top" Spacing="5" Margin="0,0,0,5">
                                <Button Command="{Binding ImageEffects.AddPresetCommand}" Content="Add"/>
                                <Button Command="{Binding ImageEffects.RemovePresetCommand}" Content="Remove"/>
                            </StackPanel>
                            <ListBox ItemsSource="{Binding ImageEffects.Presets}" SelectedItem="{Binding ImageEffects.SelectedPreset}" BorderThickness="1" BorderBrush="{DynamicResource SystemControlForegroundBaseLowBrush}"/>
                        </DockPanel>

                        <!-- Effects List -->
                        <DockPanel Grid.Column="1" Margin="5,0,5,0">
                            <TextBlock Text="Effects:" DockPanel.Dock="Top" Margin="0,0,0,5"/>
                            <StackPanel Orientation="Horizontal" DockPanel.Dock="Top" Spacing="5" Margin="0,0,0,5">
                                <Button Content="Add...">
                                    <Button.Flyout>
                                        <Flyout Placement="BottomEdgeAlignedLeft" ShowMode="Standard">
                                            <Menu ItemsSource="{Binding ImageEffects.AvailableEffects}">
                                                <Menu.Styles>
                                                    <Style Selector="MenuItem" x:DataType="vm:EffectCategory">
                                                        <Setter Property="Header" Value="{Binding Name}"/>
                                                        <Setter Property="ItemsSource" Value="{Binding Effects}"/>
                                                    </Style>
                                                    <Style Selector="MenuItem" x:DataType="vm:EffectType">
                                                        <Setter Property="Header" Value="{Binding Name}"/>
                                                        <Setter Property="Command" Value="{Binding $parent[UserControl].DataContext.ImageEffects.AddEffectCommand}"/>
                                                        <Setter Property="CommandParameter" Value="{Binding Type}"/>
                                                    </Style>
                                                </Menu.Styles>
                                            </Menu>
                                        </Flyout>
                                    </Button.Flyout>
                                </Button>
                                <Button Command="{Binding ImageEffects.RemoveEffectCommand}" Content="Remove"/>
                            </StackPanel>
                            <ListBox ItemsSource="{Binding ImageEffects.Effects}" SelectedItem="{Binding ImageEffects.SelectedEffect}" BorderThickness="1" BorderBrush="{DynamicResource SystemControlForegroundBaseLowBrush}"/>
                        </DockPanel>

                        <!-- Property Grid -->
                        <DockPanel Grid.Column="2" Margin="5,0,5,0">
                            <TextBlock Text="Properties:" DockPanel.Dock="Top" Margin="0,0,0,5"/>
                            <Border BorderThickness="1" BorderBrush="{DynamicResource SystemControlForegroundBaseLowBrush}">
                                <controls:PropertyGrid x:Name="EffectPropertyGrid" SelectedObject="{Binding ImageEffects.SelectedEffect}" Margin="5"/>
                            </Border>
                        </DockPanel>

                        <!-- Preview Panel -->
                        <DockPanel Grid.Column="3" Margin="5,0,0,0">
                            <TextBlock Text="Preview:" DockPanel.Dock="Top" Margin="0,0,0,5"/>
                            <Border BorderThickness="1" BorderBrush="{DynamicResource SystemControlForegroundBaseLowBrush}">
                                <Image Source="{Binding ImageEffects.PreviewBitmap}" Stretch="Uniform" Margin="5"/>
                            </Border>
                        </DockPanel>
                    </Grid>
                </Grid>
            </TabItem>

            <!-- Upload Tab -->
            <TabItem Header="Upload">
                <ScrollViewer>
                    <StackPanel Margin="20" Spacing="20">
                        <StackPanel Spacing="10">
                            <TextBlock Text="File naming" FontWeight="SemiBold"/>
                            <Border BorderBrush="{DynamicResource SystemControlForegroundBaseLowBrush}" BorderThickness="1" CornerRadius="4" Padding="10">
                                <StackPanel Spacing="10">
                                    <Grid ColumnDefinitions="Auto, 10, *">
                                        <TextBlock Grid.Column="0" Text="Name pattern:" VerticalAlignment="Center"/>
                                        <TextBox Grid.Column="2" Text="{Binding NameFormatPattern, Mode=TwoWay}"/>
                                    </Grid>
                                    <Grid ColumnDefinitions="Auto, 10, *">
                                        <TextBlock Grid.Column="0" Text="Active window name pattern:" VerticalAlignment="Center"/>
                                        <TextBox Grid.Column="2" Text="{Binding NameFormatPatternActiveWindow, Mode=TwoWay}"/>
                                    </Grid>
                                    <CheckBox IsChecked="{Binding FileUploadUseNamePattern}" Content="Use name pattern for file uploaders"/>
                                    <CheckBox IsChecked="{Binding FileUploadReplaceProblematicCharacters}" Content="Replace potentially problematic characters"/>
                                    <CheckBox IsChecked="{Binding URLRegexReplace}" Content="Perform regex replace on URL"/>
                                    <Grid ColumnDefinitions="Auto, 10, *" IsVisible="{Binding URLRegexReplace}">
                                        <TextBlock Grid.Column="0" Text="Regex pattern:" VerticalAlignment="Center"/>
                                        <TextBox Grid.Column="2" Text="{Binding URLRegexReplacePattern, Mode=TwoWay}"/>
                                    </Grid>
                                    <Grid ColumnDefinitions="Auto, 10, *" IsVisible="{Binding URLRegexReplace}">
                                        <TextBlock Grid.Column="0" Text="Replacement:" VerticalAlignment="Center"/>
                                        <TextBox Grid.Column="2" Text="{Binding URLRegexReplaceReplacement, Mode=TwoWay}"/>
                                    </Grid>
                                </StackPanel>
                            </Border>
                        </StackPanel>

                        <StackPanel Spacing="10">
                            <TextBlock Text="Clipboard upload" FontWeight="SemiBold"/>
                            <Border BorderBrush="{DynamicResource SystemControlForegroundBaseLowBrush}" BorderThickness="1" CornerRadius="4" Padding="10">
                                <StackPanel Spacing="10">
                                    <CheckBox IsChecked="{Binding ClipboardUploadURLContents}" Content="Upload URL contents"/>
                                    <CheckBox IsChecked="{Binding ClipboardUploadShortenURL}" Content="Shorten URL"/>
                                </StackPanel>
                            </Border>
                        </StackPanel>



                        <!-- After Upload Tasks Section -->
                        <StackPanel Spacing="10">
                            <TextBlock Text="After upload" FontWeight="SemiBold"/>
                            <Border BorderBrush="{DynamicResource SystemControlForegroundBaseLowBrush}" BorderThickness="1" CornerRadius="4" Padding="10">
                                <StackPanel Spacing="10">
                                    <TextBlock Text="Choose actions to perform automatically after upload" 
                                               FontSize="12" 
                                               Foreground="Gray" 
                                               Margin="0,0,0,4"/>
                                    <CheckBox IsChecked="{Binding CopyURLToClipboard}" 
                                              Content="Copy URL to clipboard"
                                              FontWeight="SemiBold"/>
                                    <CheckBox IsChecked="{Binding UseURLShortener}" 
                                              Content="Use URL shortener"/>
                                    <CheckBox IsChecked="{Binding ShareURL}" 
                                              Content="Share URL"/>
                                </StackPanel>
                            </Border>
                        </StackPanel>
                    </StackPanel>
                </ScrollViewer>
            </TabItem>

            <!-- Actions Tab -->
            <TabItem Header="Actions">
                 <TextBlock Text="Actions actions placeholder" Margin="20" Foreground="Gray"/>
            </TabItem>

             <!-- Advanced Tab -->
            <TabItem Header="Advanced">
                 <TextBlock Text="Advanced settings placeholder" Margin="20" Foreground="Gray"/>
            </TabItem>

            <!-- Tools Tab -->
            <TabItem Header="Tools">
                <ScrollViewer>
                    <StackPanel Margin="20" Spacing="20">
                        <StackPanel Spacing="10">
                            <TextBlock Text="Capture" FontWeight="SemiBold"/>
                            <Border BorderBrush="{DynamicResource SystemControlForegroundBaseLowBrush}" BorderThickness="1" CornerRadius="4" Padding="10">
                                <StackPanel Spacing="10">
                                    <TextBlock Text="Configure FFmpeg fallback options for screen recording and audio capture."
                                               Foreground="{DynamicResource TextFillColorSecondaryBrush}"
                                               FontSize="12"
                                               TextWrapping="Wrap"/>
                                    <Button Content="Configure FFmpeg..."
                                            Command="{Binding OpenFFmpegOptionsCommand}"
                                            HorizontalAlignment="Left"/>
                                </StackPanel>
                            </Border>
                        </StackPanel>
                    </StackPanel>
                </ScrollViewer>
            </TabItem>
        </TabControl>
    </Grid>
</UserControl>
