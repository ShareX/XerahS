<UserControl xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:vm="using:XerahS.UI.ViewModels"
             xmlns:history="using:XerahS.History"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             mc:Ignorable="d" d:DesignWidth="800" d:DesignHeight="600"
             x:Class="XerahS.UI.Views.HistoryView"
             x:DataType="vm:HistoryViewModel"
             x:Name="Root"
             Cursor="Arrow">
    
    <Design.DataContext>
        <vm:HistoryViewModel/>
    </Design.DataContext>

    <UserControl.Resources>
        <!-- Shared MenuFlyout Resource -->
        <MenuFlyout x:Key="HistoryItemMenuFlyout">
            <MenuItem Header="Edit..." 
                      Command="{Binding $parent[UserControl].DataContext.EditImageCommand}"
                      CommandParameter="{Binding}"
                      InputGesture="Enter"/>
            <MenuItem Header="Open File" 
                      Command="{Binding $parent[UserControl].DataContext.OpenFileCommand}"
                      CommandParameter="{Binding}"
                      InputGesture="Ctrl+Click"/>
            <MenuItem Header="Show in Explorer" 
                      Command="{Binding $parent[UserControl].DataContext.OpenFolderCommand}"
                      CommandParameter="{Binding}"/>
            <Separator/>
            <MenuItem Header="Copy Path" 
                      Command="{Binding $parent[UserControl].DataContext.CopyFilePathCommand}"
                      CommandParameter="{Binding}"/>
            <MenuItem Header="Copy URL" 
                      Command="{Binding $parent[UserControl].DataContext.CopyURLCommand}"
                      CommandParameter="{Binding}"
                      IsVisible="{Binding URL, Converter={x:Static StringConverters.IsNotNullOrEmpty}}"/>
            <MenuItem Header="Open URL" 
                      Command="{Binding $parent[UserControl].DataContext.OpenURLCommand}"
                      CommandParameter="{Binding}"
                      IsVisible="{Binding URL, Converter={x:Static StringConverters.IsNotNullOrEmpty}}"/>
            <Separator/>
            <MenuItem Header="Delete" 
                      Command="{Binding $parent[UserControl].DataContext.DeleteItemCommand}"
                      CommandParameter="{Binding}"
                      InputGesture="Delete"/>
        </MenuFlyout>
    </UserControl.Resources>

    <Grid RowDefinitions="Auto, Auto, *, Auto">
        <!-- Toolbar -->
        <Border Grid.Row="0" Padding="16" Background="{DynamicResource SolidBackgroundFillColorBaseBrush}"
                BorderBrush="{DynamicResource CardStrokeColorDefaultBrush}" BorderThickness="0,0,0,1">
            <StackPanel Orientation="Horizontal" Spacing="16">
                <Button Content="Refresh" Command="{Binding RefreshHistoryCommand}" 
                        IsEnabled="{Binding !IsLoading}"
                        AutomationProperties.Name="Refresh History"/>
                <Button Content="{Binding IsGridView, Converter={x:Static vm:HistoryViewModel.ViewToggleConverter}}" 
                        Command="{Binding ToggleViewCommand}"
                        IsEnabled="{Binding !IsLoading}"
                        AutomationProperties.Name="Toggle View Mode"/>
                
                <Separator Classes="vertical" Height="20"/>

                <TextBlock Text="{Binding HistoryItems.Count, StringFormat='{}{0} items'}" 
                           VerticalAlignment="Center" 
                           Foreground="{DynamicResource TextFillColorSecondaryBrush}"/>
                
                <ProgressBar IsIndeterminate="True" 
                             Width="100" Height="2" 
                             IsVisible="{Binding IsLoadingThumbnails}"
                             VerticalAlignment="Center"
                             AutomationProperties.Name="Loading Thumbnails"/>
            </StackPanel>
        </Border>
        
        <!-- Loading State -->
        <Border Grid.Row="2" IsVisible="{Binding IsLoading}" Background="{DynamicResource SolidBackgroundFillColorBaseBrush}">
            <StackPanel Spacing="16" VerticalAlignment="Center" HorizontalAlignment="Center">
                <ProgressBar IsIndeterminate="True" Width="200"/>
                <TextBlock Text="Loading history..." HorizontalAlignment="Center" Foreground="{DynamicResource TextFillColorSecondaryBrush}"/>
            </StackPanel>
        </Border>
        
        <!-- List View Header -->
        <Border Grid.Row="1" Padding="16,8" Background="{DynamicResource LayerFillColorDefaultBrush}" 
                BorderBrush="{DynamicResource CardStrokeColorDefaultBrush}" BorderThickness="0,0,0,1"
                IsVisible="{Binding !IsGridView}" IsEnabled="{Binding !IsLoading}">
            <Grid ColumnDefinitions="48, *, 160, 220">
                <TextBlock Grid.Column="1" Text="Filename" FontWeight="SemiBold" Foreground="{DynamicResource TextFillColorSecondaryBrush}"/>
                <TextBlock Grid.Column="2" Text="Type / Host" FontWeight="SemiBold" Foreground="{DynamicResource TextFillColorSecondaryBrush}"/>
                <TextBlock Grid.Column="3" Text="Date" FontWeight="SemiBold" Foreground="{DynamicResource TextFillColorSecondaryBrush}"/>
            </Grid>
        </Border>

        <!-- Grid View -->
        <ScrollViewer Grid.Row="2" IsVisible="{Binding IsGridView}" IsEnabled="{Binding !IsLoading}" Padding="16">
            <ItemsControl ItemsSource="{Binding HistoryItems}">
                <ItemsControl.ItemsPanel>
                    <ItemsPanelTemplate>
                        <WrapPanel Orientation="Horizontal"/>
                    </ItemsPanelTemplate>
                </ItemsControl.ItemsPanel>
                <ItemsControl.ItemTemplate>
                    <DataTemplate x:DataType="history:HistoryItem">
                        <Border Margin="8" Width="200"
                                Background="{DynamicResource CardBackgroundFillColorDefaultBrush}" 
                                BorderBrush="{DynamicResource CardStrokeColorDefaultBrush}"
                                BorderThickness="1"
                                CornerRadius="4" 
                                Padding="12"
                                Cursor="Hand"
                                Tag="{Binding #Root.DataContext}"
                                PointerPressed="OnItemPointerPressed"
                                ContextFlyout="{StaticResource HistoryItemMenuFlyout}"
                                AutomationProperties.Name="{Binding FileName, StringFormat='History Item: {0}'}">
                            <StackPanel Spacing="12">
                                <!-- Thumbnail -->
                                <Border Height="140" Background="{DynamicResource SolidBackgroundFillColorBaseBrush}" CornerRadius="4" ClipToBounds="True">
                                    <Image Source="{Binding FilePath, Converter={x:Static vm:HistoryViewModel.ThumbnailConverter}}" 
                                           Stretch="Uniform"/>
                                </Border>
                                <!-- Info -->
                                <StackPanel Spacing="4">
                                    <TextBlock Text="{Binding FileName}" FontWeight="SemiBold" TextTrimming="CharacterEllipsis"/>
                                    <TextBlock Text="{Binding DateTime, StringFormat='yyyy-MM-dd HH:mm'}" 
                                               FontSize="12" Foreground="{DynamicResource TextFillColorSecondaryBrush}"/>
                                </StackPanel>
                            </StackPanel>
                        </Border>
                    </DataTemplate>
                </ItemsControl.ItemTemplate>
            </ItemsControl>
        </ScrollViewer>
        
        <!-- List View -->
        <ScrollViewer Grid.Row="2" IsVisible="{Binding !IsGridView}" IsEnabled="{Binding !IsLoading}" Padding="0,8">
            <ItemsControl ItemsSource="{Binding HistoryItems}">
                <ItemsControl.ItemsPanel>
                    <ItemsPanelTemplate>
                        <StackPanel Spacing="2"/>
                    </ItemsPanelTemplate>
                </ItemsControl.ItemsPanel>
                <ItemsControl.ItemTemplate>
                    <DataTemplate x:DataType="history:HistoryItem">
                        <Border Padding="16,8" Background="Transparent" Cursor="Hand"
                                Tag="{Binding #Root.DataContext}"
                                PointerPressed="OnItemPointerPressed"
                                ContextFlyout="{StaticResource HistoryItemMenuFlyout}"
                                AutomationProperties.Name="{Binding FileName, StringFormat='History Item: {0}'}">
                            <Border.Styles>
                                <Style Selector="Border:pointerover">
                                    <Setter Property="Background" Value="{DynamicResource ControlFillColorSecondaryBrush}"/>
                                </Style>
                            </Border.Styles>
                            <Grid ColumnDefinitions="48, *, 160, 220">
                                <!-- Thumbnail -->
                                <Border Grid.Column="0" Width="36" Height="36" Background="{DynamicResource SolidBackgroundFillColorBaseBrush}" CornerRadius="4" ClipToBounds="True">
                                    <Image Source="{Binding FilePath, Converter={x:Static vm:HistoryViewModel.ThumbnailConverter}}" 
                                           Stretch="UniformToFill"/>
                                </Border>
                                <!-- Filename -->
                                <TextBlock Grid.Column="1" Text="{Binding FileName}" 
                                           VerticalAlignment="Center" Margin="16,0"
                                           TextTrimming="CharacterEllipsis"/>
                                <!-- Type/Host -->
                                <StackPanel Grid.Column="2" Orientation="Horizontal" VerticalAlignment="Center" Spacing="8">
                                    <TextBlock Text="{Binding Type}" FontSize="12" Foreground="{DynamicResource TextFillColorSecondaryBrush}"/>
                                    <TextBlock Text="{Binding Host}" FontSize="12" Foreground="{DynamicResource TextFillColorTertiaryBrush}"
                                               IsVisible="{Binding Host, Converter={x:Static StringConverters.IsNotNullOrEmpty}}"/>
                                </StackPanel>
                                <!-- DateTime -->
                                <TextBlock Grid.Column="3" Text="{Binding DateTime, StringFormat='yyyy-MM-dd HH:mm:ss'}" 
                                           VerticalAlignment="Center" FontSize="12" Foreground="{DynamicResource TextFillColorSecondaryBrush}"/>
                            </Grid>
                        </Border>
                    </DataTemplate>
                </ItemsControl.ItemTemplate>
            </ItemsControl>
        </ScrollViewer>

        <!-- Pagination Footer -->
        <Border Grid.Row="3" Padding="16" Background="{DynamicResource SolidBackgroundFillColorBaseBrush}" 
                BorderBrush="{DynamicResource CardStrokeColorDefaultBrush}" BorderThickness="0,1,0,0">
            <StackPanel Orientation="Horizontal" HorizontalAlignment="Center" Spacing="24">
                <Button Content="Previous" Command="{Binding PreviousPageCommand}" 
                        IsEnabled="{Binding CanGoPrevious}"
                        AutomationProperties.Name="Previous Page"/>
                
                <TextBlock Text="{Binding PageInfo}" VerticalAlignment="Center" 
                           Foreground="{DynamicResource TextFillColorSecondaryBrush}"/>
                
                <Button Content="Next" Command="{Binding NextPageCommand}" 
                        IsEnabled="{Binding CanGoNext}"
                        AutomationProperties.Name="Next Page"/>
            </StackPanel>
        </Border>
    </Grid>
</UserControl>
