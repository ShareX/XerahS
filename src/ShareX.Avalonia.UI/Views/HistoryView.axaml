<UserControl xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:vm="using:XerahS.UI.ViewModels"
             xmlns:history="using:XerahS.History"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             mc:Ignorable="d" d:DesignWidth="800" d:DesignHeight="450"
             x:Class="XerahS.UI.Views.HistoryView"
             x:DataType="vm:HistoryViewModel"
             x:Name="Root"
             Cursor="Arrow">
    
    <Design.DataContext>
        <vm:HistoryViewModel/>
    </Design.DataContext>

    <UserControl.Resources>
        <!-- Shared MenuFlyout Resource -->
        <MenuFlyout x:Key="HistoryItemMenuFlyout">
            <MenuItem Header="âœï¸ Open in Editor..." 
                      Command="{Binding $parent[UserControl].DataContext.EditImageCommand}"
                      CommandParameter="{Binding}"/>
            <MenuItem Header="ðŸ“„ Open File (Ctrl+Click)" 
                      Command="{Binding $parent[UserControl].DataContext.OpenFileCommand}"
                      CommandParameter="{Binding}"/>
            <MenuItem Header="ðŸ“‚ Show in File Explorer..." 
                      Command="{Binding $parent[UserControl].DataContext.OpenFolderCommand}"
                      CommandParameter="{Binding}"/>
            <Separator/>
            <MenuItem Header="ðŸ“‹ Copy File Path" 
                      Command="{Binding $parent[UserControl].DataContext.CopyFilePathCommand}"
                      CommandParameter="{Binding}"/>
            <MenuItem Header="ðŸ”— Copy URL" 
                      Command="{Binding $parent[UserControl].DataContext.CopyURLCommand}"
                      CommandParameter="{Binding}"
                      IsVisible="{Binding URL, Converter={x:Static StringConverters.IsNotNullOrEmpty}}"/>
            <Separator/>
            <MenuItem Header="ðŸ—‘ï¸ Delete from History..." 
                      Command="{Binding $parent[UserControl].DataContext.DeleteItemCommand}"
                      CommandParameter="{Binding}"/>
        </MenuFlyout>
    </UserControl.Resources>

    <Grid RowDefinitions="Auto,Auto,*,Auto">
        <!-- Toolbar -->
        <Border Grid.Row="0" Padding="12,8">
            <StackPanel Orientation="Horizontal" Spacing="10">
                <Button Content="ðŸ”„ Refresh" Command="{Binding RefreshHistoryCommand}" 
                        Padding="12,8" CornerRadius="8" IsEnabled="{Binding !IsLoading}"/>
                <Button Content="{Binding IsGridView, Converter={x:Static vm:HistoryViewModel.ViewToggleConverter}}" 
                        Command="{Binding ToggleViewCommand}"
                        Padding="12,8" CornerRadius="8" IsEnabled="{Binding !IsLoading}"/>
                <TextBlock Text="{Binding HistoryItems.Count, StringFormat='ðŸ“ {0} items'}" 
                           VerticalAlignment="Center" Foreground="{DynamicResource SystemControlForegroundBaseMediumBrush}" Margin="10,0,0,0"/>
                <TextBlock Text="{Binding IsLoadingThumbnails, StringFormat=' (loading thumbnails...)'}" 
                           VerticalAlignment="Center" Foreground="{DynamicResource SystemControlForegroundBaseMediumBrush}"
                           IsVisible="{Binding IsLoadingThumbnails}" FontSize="12" Margin="5,0,0,0"/>
            </StackPanel>
        </Border>
        
        <!-- Loading Indicator (full history load) -->
        <Border Grid.Row="1" Padding="20" Background="#1a1a2e" IsVisible="{Binding IsLoading}">
            <StackPanel Spacing="16" VerticalAlignment="Center" HorizontalAlignment="Center">
                <TextBlock Text="Loading history..." FontSize="16" Foreground="White" HorizontalAlignment="Center"/>
                <ProgressBar IsIndeterminate="True" Width="200" Height="4" CornerRadius="2"/>
            </StackPanel>
        </Border>
        
        <!-- List View Header (only visible in list mode) -->
        <Border Grid.Row="1" Padding="12,4" Background="#1a1a2e" IsVisible="{Binding !IsGridView}" IsEnabled="{Binding !IsLoading}">
            <Grid ColumnDefinitions="50,*,150,200">
                <TextBlock Grid.Column="0" Text="" Foreground="#9CA3AF" FontSize="11" FontWeight="SemiBold"/>
                <TextBlock Grid.Column="1" Text="Filename" Foreground="#9CA3AF" FontSize="11" FontWeight="SemiBold" Margin="8,0"/>
                <TextBlock Grid.Column="2" Text="Type / Host" Foreground="#9CA3AF" FontSize="11" FontWeight="SemiBold"/>
                <TextBlock Grid.Column="3" Text="Date &amp; Time" Foreground="#9CA3AF" FontSize="11" FontWeight="SemiBold"/>
            </Grid>
        </Border>

        <!-- Grid View -->
        <ScrollViewer Grid.Row="2" IsVisible="{Binding IsGridView}" IsEnabled="{Binding !IsLoading}">
            <ItemsControl ItemsSource="{Binding HistoryItems}" Margin="12">
                <ItemsControl.ItemsPanel>
                    <ItemsPanelTemplate>
                        <WrapPanel Orientation="Horizontal"/>
                    </ItemsPanelTemplate>
                </ItemsControl.ItemsPanel>
                <ItemsControl.ItemTemplate>
                    <DataTemplate x:DataType="history:HistoryItem">
                        <Border Margin="6" Background="#252535" CornerRadius="8" 
                                Width="180" Padding="8" Cursor="Hand"
                                Tag="{Binding #Root.DataContext}"
                                PointerPressed="OnItemPointerPressed"
                                ContextFlyout="{StaticResource HistoryItemMenuFlyout}">
                            <StackPanel Spacing="8">
                                <!-- Thumbnail -->
                                <Border Height="120" Background="#1a1a2e" CornerRadius="6" ClipToBounds="True">
                                    <Image Source="{Binding FilePath, Converter={x:Static vm:HistoryViewModel.ThumbnailConverter}}" 
                                           Stretch="UniformToFill"
                                           HorizontalAlignment="Center" VerticalAlignment="Center"/>
                                </Border>
                                <!-- Info -->
                                <TextBlock Text="{Binding FileName}" FontWeight="SemiBold" Foreground="White"
                                           TextTrimming="CharacterEllipsis" ToolTip.Tip="{Binding FileName}"/>
                                <TextBlock Text="{Binding DateTime, StringFormat='yyyy-MM-dd HH:mm'}" 
                                           FontSize="11" Foreground="#6B7280"/>
                            </StackPanel>
                        </Border>
                    </DataTemplate>
                </ItemsControl.ItemTemplate>
            </ItemsControl>
        </ScrollViewer>
        
        <!-- List View -->
        <ScrollViewer Grid.Row="2" IsVisible="{Binding !IsGridView}" IsEnabled="{Binding !IsLoading}">
            <ItemsControl ItemsSource="{Binding HistoryItems}" Margin="12,4">
                <ItemsControl.ItemsPanel>
                    <ItemsPanelTemplate>
                        <StackPanel/>
                    </ItemsPanelTemplate>
                </ItemsControl.ItemsPanel>
                <ItemsControl.ItemTemplate>
                    <DataTemplate x:DataType="history:HistoryItem">
                        <Border Margin="2" Background="#252535" CornerRadius="4" Padding="8" Cursor="Hand"
                                Tag="{Binding #Root.DataContext}"
                                PointerPressed="OnItemPointerPressed"
                                ContextFlyout="{StaticResource HistoryItemMenuFlyout}">
                            <Grid ColumnDefinitions="50,*,150,200">
                                <!-- Thumbnail -->
                                <Border Grid.Column="0" Width="40" Height="40" Background="#1a1a2e" CornerRadius="4" ClipToBounds="True">
                                    <Image Source="{Binding FilePath, Converter={x:Static vm:HistoryViewModel.ThumbnailConverter}}" 
                                           Stretch="UniformToFill"/>
                                </Border>
                                <!-- Filename -->
                                <TextBlock Grid.Column="1" Text="{Binding FileName}" 
                                           Foreground="White" VerticalAlignment="Center" Margin="8,0"
                                           TextTrimming="CharacterEllipsis" ToolTip.Tip="{Binding FilePath}"/>
                                <!-- Type/Host -->
                                <StackPanel Grid.Column="2" Orientation="Horizontal" VerticalAlignment="Center" Spacing="8">
                                    <TextBlock Text="{Binding Type}" Foreground="#9CA3AF" FontSize="12"/>
                                    <TextBlock Text="{Binding Host}" Foreground="#6B7280" FontSize="12"
                                               IsVisible="{Binding Host, Converter={x:Static StringConverters.IsNotNullOrEmpty}}"/>
                                </StackPanel>
                                <!-- DateTime -->
                                <TextBlock Grid.Column="3" Text="{Binding DateTime, StringFormat='yyyy-MM-dd HH:mm:ss'}" 
                                           Foreground="#6B7280" VerticalAlignment="Center" FontSize="12"/>
                            </Grid>
                        </Border>
                    </DataTemplate>
                </ItemsControl.ItemTemplate>
            </ItemsControl>
        </ScrollViewer>
        <!-- Pagination Footer -->
        <Border Grid.Row="3" Padding="12" Background="#1a1a2e" BorderBrush="#374151" BorderThickness="0,1,0,0">
            <StackPanel Orientation="Horizontal" HorizontalAlignment="Center" Spacing="20">
                <Button Content="â—€ Previous" Command="{Binding PreviousPageCommand}" 
                        IsEnabled="{Binding CanGoPrevious}" Padding="16,8"/>
                
                <TextBlock Text="{Binding PageInfo}" VerticalAlignment="Center" 
                           Foreground="#9CA3AF" FontWeight="SemiBold"/>
                
                <Button Content="Next â–¶" Command="{Binding NextPageCommand}" 
                        IsEnabled="{Binding CanGoNext}" Padding="16,8"/>
            </StackPanel>
        </Border>
    </Grid>
</UserControl>
