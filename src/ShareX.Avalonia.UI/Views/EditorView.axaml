<UserControl xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             xmlns:vm="using:ShareX.Ava.UI.ViewModels"
             xmlns:views="using:ShareX.Ava.UI.Views"
             xmlns:models="using:ShareX.Ava.Annotations.Models"
             xmlns:converters="using:ShareX.Ava.UI.Converters"
             mc:Ignorable="d" d:DesignWidth="1200" d:DesignHeight="800"
             x:Class="ShareX.Ava.UI.Views.EditorView"
             x:DataType="vm:MainViewModel"
             Focusable="True"
             KeyDown="OnKeyDown">

    <UserControl.Resources>
        <converters:DoubleToCornerRadiusConverter x:Key="DoubleToCornerRadius" />
    </UserControl.Resources>

    <Grid RowDefinitions="Auto,Auto,*,Auto,Auto">
        <!-- Row 0: Capture Toolbar -->
        <Border Grid.Row="0" Background="#252535" Padding="16,12">
            <DockPanel>
                <!-- Capture Buttons (Left) -->
                <StackPanel DockPanel.Dock="Left" Orientation="Horizontal" Spacing="8">
                    <Button Command="{Binding CaptureFullscreenCommand}"
                            Background="#8B5CF6"
                            Foreground="White"
                            Padding="16,10"
                            CornerRadius="12"
                            FontWeight="SemiBold">
                        Fullscreen
                    </Button>
                    <Button Command="{Binding CaptureRegionCommand}"
                            Background="#14B8A6"
                            Foreground="White"
                            Padding="16,10"
                            CornerRadius="12"
                            FontWeight="SemiBold">
                        Region
                    </Button>
                    <Button Command="{Binding CaptureWindowCommand}"
                            Background="#EC4899"
                            Foreground="White"
                            Padding="16,10"
                            CornerRadius="12"
                            FontWeight="SemiBold">
                        Window
                    </Button>
                    <Button Command="{Binding ClearCommand}"
                            Background="Transparent"
                            BorderBrush="#3B3B52"
                            BorderThickness="1"
                            Foreground="White"
                            Padding="16,10"
                            CornerRadius="12"
                            IsVisible="{Binding HasPreviewImage}">
                        Clear
                    </Button>
                </StackPanel>
                
                <!-- Settings Button (Right) - REMOVED -->
            </DockPanel>
        </Border>

        <!-- Row 1: Annotation Toolbar (only visible when screenshot exists) -->
        <Border Grid.Row="1" 
                Background="#2A2A3E" 
                Padding="12,8"
                IsVisible="{Binding HasPreviewImage}">
            <StackPanel Orientation="Vertical" Spacing="10">
                <!-- Row 1: Tools only -->
                <Border BorderThickness="0,0,0,1" BorderBrush="#3B3B52" Padding="0,0,0,8">
                    <ScrollViewer HorizontalScrollBarVisibility="Auto" VerticalScrollBarVisibility="Disabled">
                        <StackPanel Orientation="Horizontal" Spacing="4">
                            <Button Content="V" Width="40" Height="40" 
                                    Command="{Binding SelectToolCommand}" CommandParameter="{x:Static models:EditorTool.Select}"
                                    Background="{Binding ActiveTool, Converter={StaticResource ActiveToolToBackground}, ConverterParameter=Select}" 
                                    Foreground="White" CornerRadius="8" ToolTip.Tip="Select (V)"/>
                            
                            <!-- Shapes -->
                            <Button Content="â–­" Width="40" Height="40" 
                                    Command="{Binding SelectToolCommand}" CommandParameter="{x:Static models:EditorTool.Rectangle}"
                                    Background="{Binding ActiveTool, Converter={StaticResource ActiveToolToBackground}, ConverterParameter=Rectangle}" 
                                    Foreground="White" CornerRadius="8" ToolTip.Tip="Rectangle (R)"/>
                            <Button Content="â—‹" Width="40" Height="40" 
                                    Command="{Binding SelectToolCommand}" CommandParameter="{x:Static models:EditorTool.Ellipse}"
                                    Background="{Binding ActiveTool, Converter={StaticResource ActiveToolToBackground}, ConverterParameter=Ellipse}" 
                                    Foreground="White" CornerRadius="8" ToolTip.Tip="Ellipse (E)"/>
                            <Button Content="â€”" Width="40" Height="40" 
                                    Command="{Binding SelectToolCommand}" CommandParameter="{x:Static models:EditorTool.Line}"
                                    Background="{Binding ActiveTool, Converter={StaticResource ActiveToolToBackground}, ConverterParameter=Line}" 
                                    Foreground="White" CornerRadius="8" ToolTip.Tip="Line (L)"/>
                            <Button Content="â†’" Width="40" Height="40" 
                                    Command="{Binding SelectToolCommand}" CommandParameter="{x:Static models:EditorTool.Arrow}"
                                    Background="{Binding ActiveTool, Converter={StaticResource ActiveToolToBackground}, ConverterParameter=Arrow}" 
                                    Foreground="White" CornerRadius="8" ToolTip.Tip="Arrow (A)"/>
                            
                            <!-- Drawing -->
                            <Button Content="âœï¸" Width="40" Height="40" 
                                    Command="{Binding SelectToolCommand}" CommandParameter="{x:Static models:EditorTool.Pen}"
                                    Background="{Binding ActiveTool, Converter={StaticResource ActiveToolToBackground}, ConverterParameter=Pen}" 
                                    Foreground="White" CornerRadius="8" ToolTip.Tip="Freehand (P)"/>
                            <Button Content="ðŸ–ï¸" Width="40" Height="40" 
                                    Command="{Binding SelectToolCommand}" CommandParameter="{x:Static models:EditorTool.Highlighter}"
                                    Background="{Binding ActiveTool, Converter={StaticResource ActiveToolToBackground}, ConverterParameter=Highlighter}" 
                                    Foreground="White" CornerRadius="8" ToolTip.Tip="Highlighter (H)"/>

                            <!-- Text & Annotations -->
                            <Button Content="T" Width="40" Height="40" 
                                    Command="{Binding SelectToolCommand}" CommandParameter="{x:Static models:EditorTool.Text}"
                                    Background="{Binding ActiveTool, Converter={StaticResource ActiveToolToBackground}, ConverterParameter=Text}" 
                                    Foreground="White" CornerRadius="8" ToolTip.Tip="Text (T)"/>
                            <Button Content="ðŸ’¬" Width="40" Height="40" 
                                    Command="{Binding SelectToolCommand}" CommandParameter="{x:Static models:EditorTool.SpeechBalloon}"
                                    Background="{Binding ActiveTool, Converter={StaticResource ActiveToolToBackground}, ConverterParameter=SpeechBalloon}" 
                                    Foreground="White" CornerRadius="8" ToolTip.Tip="Speech Balloon (B)"/>
                            <Button Content="â‘ " Width="40" Height="40" 
                                    Command="{Binding SelectToolCommand}" CommandParameter="{x:Static models:EditorTool.Number}"
                                    Background="{Binding ActiveTool, Converter={StaticResource ActiveToolToBackground}, ConverterParameter=Number}" 
                                    Foreground="White" CornerRadius="8" ToolTip.Tip="Step/Number (N)"/>

                            <!-- Effects & Utils -->
                            <Button Content="ðŸ’§" Width="40" Height="40" 
                                    Command="{Binding SelectToolCommand}" CommandParameter="{x:Static models:EditorTool.Blur}"
                                    Background="{Binding ActiveTool, Converter={StaticResource ActiveToolToBackground}, ConverterParameter=Blur}" 
                                    Foreground="White" CornerRadius="8" ToolTip.Tip="Blur Region"/>
                            <Button Content="â–’" Width="40" Height="40" 
                                    Command="{Binding SelectToolCommand}" CommandParameter="{x:Static models:EditorTool.Pixelate}"
                                    Background="{Binding ActiveTool, Converter={StaticResource ActiveToolToBackground}, ConverterParameter=Pixelate}" 
                                    Foreground="White" CornerRadius="8" ToolTip.Tip="Pixelate Region"/>
                            <Button Content="ðŸ”" Width="40" Height="40" 
                                    Command="{Binding SelectToolCommand}" CommandParameter="{x:Static models:EditorTool.Magnify}"
                                    Background="{Binding ActiveTool, Converter={StaticResource ActiveToolToBackground}, ConverterParameter=Magnify}" 
                                    Foreground="White" CornerRadius="8" ToolTip.Tip="Magnifier (M)"/>
                            <Button Content="ðŸ”¦" Width="40" Height="40" 
                                    Command="{Binding SelectToolCommand}" CommandParameter="{x:Static models:EditorTool.Spotlight}"
                                    Background="{Binding ActiveTool, Converter={StaticResource ActiveToolToBackground}, ConverterParameter=Spotlight}" 
                                    Foreground="White" CornerRadius="8" ToolTip.Tip="Spotlight (S)"/>
                            <Button Content="ðŸª„" Width="40" Height="40" 
                                    Command="{Binding SelectToolCommand}" CommandParameter="{x:Static models:EditorTool.SmartEraser}"
                                    Background="{Binding ActiveTool, Converter={StaticResource ActiveToolToBackground}, ConverterParameter=SmartEraser}" 
                                    Foreground="White" CornerRadius="8" ToolTip.Tip="Smart Eraser"/>

                            <Button Content="âœ‚" Width="40" Height="40" 
                                    Command="{Binding SelectToolCommand}" CommandParameter="{x:Static models:EditorTool.Crop}"
                                    Background="{Binding ActiveTool, Converter={StaticResource ActiveToolToBackground}, ConverterParameter=Crop}" 
                                    Foreground="White" CornerRadius="8" ToolTip.Tip="Crop (C)"/>
                            
                            <!-- Panel Toggle -->
                                <Button Content="FX" Width="40" Height="40" 
                                    Command="{Binding ToggleEffectsPanelCommand}"
                                    Background="{Binding IsEffectsPanelOpen, Converter={StaticResource BoolToActiveBackgroundConverter}}" 
                                    Foreground="White" CornerRadius="8" ToolTip.Tip="Image Effects Panel (F)"
                                    BorderBrush="#3B3B52" BorderThickness="1"/>
                        </StackPanel>
                    </ScrollViewer>
                </Border>

                <!-- Row 2: Tool options -->
                <StackPanel Orientation="Horizontal" Spacing="12">
                    <!-- Color Picker-->
                    <Border BorderThickness="0,0,1,0" BorderBrush="#3B3B52" Padding="0,0,12,0">
                        <StackPanel Orientation="Horizontal" Spacing="8">
                            <TextBlock Text="Color" FontSize="11" Foreground="#94A3B8" VerticalAlignment="Center"/>
                            <ItemsControl ItemsSource="{x:Static vm:MainViewModel.ColorPalette}">
                                <ItemsControl.ItemsPanel>
                                    <ItemsPanelTemplate>
                                        <StackPanel Orientation="Horizontal" Spacing="4"/>
                                    </ItemsPanelTemplate>
                                </ItemsControl.ItemsPanel>
                                <ItemsControl.ItemTemplate>
                                    <DataTemplate>
                                        <Button Width="28" Height="28" Padding="0"
                                                Command="{Binding DataContext.SetColorCommand, RelativeSource={RelativeSource AncestorType=UserControl}}"
                                                CommandParameter="{Binding .}"
                                                Background="Transparent"
                                                BorderThickness="0">
                                            <Border Width="24" Height="24"
                                                    Background="{Binding .}"
                                                    CornerRadius="4"
                                                    BorderThickness="2">
                                                <Border.BorderBrush>
                                                    <MultiBinding Converter="{StaticResource SelectedColorToBorder}">
                                                        <Binding Path="DataContext.SelectedColor" RelativeSource="{RelativeSource AncestorType=UserControl}"/>
                                                        <Binding />
                                                    </MultiBinding>
                                                </Border.BorderBrush>
                                            </Border>
                                        </Button>
                                    </DataTemplate>
                                </ItemsControl.ItemTemplate>
                            </ItemsControl>
                        </StackPanel>
                    </Border>
                    
                    <!-- Stroke Width -->
                    <Border BorderThickness="0,0,1,0" BorderBrush="#3B3B52" Padding="0,0,12,0">
                        <StackPanel Orientation="Horizontal" Spacing="8">
                            <TextBlock Text="Width" FontSize="11" Foreground="#94A3B8" VerticalAlignment="Center"/>
                            <ItemsControl ItemsSource="{x:Static vm:MainViewModel.StrokeWidths}">
                                <ItemsControl.ItemsPanel>
                                    <ItemsPanelTemplate>
                                        <StackPanel Orientation="Horizontal" Spacing="4"/>
                                    </ItemsPanelTemplate>
                                </ItemsControl.ItemsPanel>
                                <ItemsControl.ItemTemplate>
                                    <DataTemplate>
                                        <Button Width="32" Height="32"
                                                Command="{Binding DataContext.SetStrokeWidthCommand, RelativeSource={RelativeSource AncestorType=UserControl}}"
                                                CommandParameter="{Binding .}"
                                            CornerRadius="8"
                                            BorderBrush="#3B3B52" BorderThickness="1"
                                                ToolTip.Tip="{Binding ., StringFormat='{}{0}px'}">
                                            <Button.Background>
                                                <MultiBinding Converter="{StaticResource SelectedWidthToBackground}">
                                                    <Binding Path="DataContext.StrokeWidth" RelativeSource="{RelativeSource AncestorType=UserControl}"/>
                                                    <Binding />
                                                </MultiBinding>
                                            </Button.Background>
                                            <Ellipse Width="{Binding .}"
                                                     Height="{Binding .}"
                                                     Fill="#94A3B8"/>
                                        </Button>
                                    </DataTemplate>
                                </ItemsControl.ItemTemplate>
                            </ItemsControl>
                        </StackPanel>
                    </Border>
                    
                    <!-- Undo/Redo -->
                    <Border BorderThickness="0,0,1,0" BorderBrush="#3B3B52" Padding="0,0,12,0">
                        <StackPanel Orientation="Horizontal" Spacing="4">
                                <Button Content="â†¶" Width="32" Height="32" Background="#25263A" Foreground="#E2E8F0" CornerRadius="8" 
                                    BorderBrush="#3B3B52" BorderThickness="1"
                                    Command="{Binding UndoCommand}" ToolTip.Tip="Undo (Ctrl+Z)"/>
                                <Button Content="â†·" Width="32" Height="32" Background="#25263A" Foreground="#E2E8F0" CornerRadius="8" 
                                    BorderBrush="#3B3B52" BorderThickness="1"
                                    Command="{Binding RedoCommand}" ToolTip.Tip="Redo (Ctrl+Shift+Z)"/>
                        </StackPanel>
                    </Border>
                    
                    <!-- Delete / Clear -->
                    <StackPanel Orientation="Horizontal" Spacing="6">
                        <Button Content="ðŸ§¹" Width="32" Height="32" Background="#25263A" Foreground="#E2E8F0" CornerRadius="8"
                            BorderBrush="#3B3B52" BorderThickness="1"
                            Command="{Binding ClearAnnotationsCommand}" ToolTip.Tip="Clear all annotations"/>
                        <Button Content="ðŸ—‘" Width="32" Height="32" Background="#25263A" Foreground="#F43F5E" CornerRadius="8" 
                            BorderBrush="#3B3B52" BorderThickness="1"
                            Command="{Binding DeleteSelectedCommand}" ToolTip.Tip="Delete Selected (Del)"/>
                    </StackPanel>
                </StackPanel>
            </StackPanel>
        </Border>

        <!-- Row 2: Main Content Area with Preview and Sidebar -->
        <Grid Grid.Row="2" ColumnDefinitions="*,288">
            
            <!-- Central Preview Canvas -->
             <Grid Grid.Column="0" Margin="20">
                 <Border Background="{Binding CanvasBackground}"
                         Padding="{Binding CanvasPadding}">
                     <!-- Outer Border: Shadow effect -->
                     <Border BoxShadow="{Binding CanvasShadow}"
                            CornerRadius="{Binding CanvasCornerRadius, Converter={StaticResource DoubleToCornerRadius}}">
                         <!-- Inner Border: Corner Radius with clipping -->
                         <Border Background="#FFFFFF"
                                 CornerRadius="{Binding CanvasCornerRadius, Converter={StaticResource DoubleToCornerRadius}}"
                                 ClipToBounds="True">
                            <ScrollViewer Name="CanvasScrollViewer"
                                          Background="Transparent"
                                          HorizontalScrollBarVisibility="Auto"
                                          VerticalScrollBarVisibility="Auto"
                                          PointerPressed="OnScrollViewerPointerPressed"
                                          PointerMoved="OnScrollViewerPointerMoved"
                                          PointerReleased="OnScrollViewerPointerReleased">
                                <LayoutTransformControl>
                                    <LayoutTransformControl.LayoutTransform>
                                        <ScaleTransform ScaleX="{Binding Zoom}" ScaleY="{Binding Zoom}" />
                                    </LayoutTransformControl.LayoutTransform>

                                    <!-- Container sized to match actual image dimensions -->
                                    <Border CornerRadius="{Binding CanvasCornerRadius, Converter={StaticResource DoubleToCornerRadius}}"
                                             ClipToBounds="True"
                                             Background="Transparent">
                                        <Grid Name="CanvasContainer" 
                                              Width="{Binding ImageWidth}" 
                                              Height="{Binding ImageHeight}">
                                        
                                        <!-- Image Layer -->
                                        <Image Name="PreviewImageControl"
                                               Source="{Binding PreviewImage}"
                                               Stretch="Uniform"
                                               HorizontalAlignment="Stretch"
                                               VerticalAlignment="Stretch"/>

                                        <!-- Annotation Layer (Saved content) -->
                                        <Canvas Name="AnnotationCanvas"
                                                Background="Transparent"
                                                IsVisible="{Binding HasPreviewImage}"
                                                HorizontalAlignment="Stretch"
                                                VerticalAlignment="Stretch"
                                                Cursor="Cross"
                                                PointerPressed="OnCanvasPointerPressed"
                                                PointerMoved="OnCanvasPointerMoved"
                                                PointerReleased="OnCanvasPointerReleased">
                                        </Canvas>

                                        <!-- Overlay Layer (Transient UI: Selection handles, Crop) -->
                                            <Canvas Name="OverlayCanvas"
                                                IsHitTestVisible="True"
                                                HorizontalAlignment="Stretch"
                                                VerticalAlignment="Stretch"
                                                PointerPressed="OnCanvasPointerPressed"
                                                PointerMoved="OnCanvasPointerMoved"
                                                PointerReleased="OnCanvasPointerReleased">
                                            <Rectangle Name="CropOverlay" 
                                                       IsVisible="False"
                                                       Stroke="White"
                                                       StrokeThickness="2"
                                                       StrokeDashArray="4,2"
                                                       Fill="#80000000" />
                                            <!-- Selection Handles will be added here dynamically -->
                                        </Canvas>
                                    </Grid>
                                    </Border>
                                </LayoutTransformControl>
                            </ScrollViewer>
                        </Border>
                    </Border>
                </Border>
            </Grid>

            <!-- Right Sidebar (Settings Panel) -->
            <Border Grid.Column="1" Background="#252535" Padding="20">
                <ScrollViewer>
                    <StackPanel Spacing="25">
                        <TextBlock Text="Settings" 
                                   FontSize="18" 
                                   FontWeight="Bold" 
                                   Foreground="White"/>

                        <!-- Padding Slider -->
                        <StackPanel Spacing="8">
                            <Grid ColumnDefinitions="*,Auto">
                                <TextBlock Grid.Column="0" Text="Padding" Foreground="#9CA3AF"/>
                                <TextBlock Grid.Column="1" Text="{Binding PreviewPadding, StringFormat='{}{0}px'}" Foreground="White"/>
                            </Grid>
                            <Slider Minimum="0" 
                                    Maximum="200" 
                                    Value="{Binding PreviewPadding}"
                                    Background="#374151"/>
                        </StackPanel>

                        <!-- Corner Radius Slider -->
                        <StackPanel Spacing="8">
                            <Grid ColumnDefinitions="*,Auto">
                                <TextBlock Grid.Column="0" Text="Corner Radius" Foreground="#9CA3AF"/>
                                <TextBlock Grid.Column="1" Text="{Binding PreviewCornerRadius, StringFormat='{}{0}px'}" Foreground="White"/>
                            </Grid>
                            <Slider Minimum="0" 
                                    Maximum="50" 
                                    Value="{Binding PreviewCornerRadius}"
                                    Background="#374151"/>
                        </StackPanel>

                        <!-- Shadow Blur Slider -->
                        <StackPanel Spacing="8">
                            <Grid ColumnDefinitions="*,Auto">
                                <TextBlock Grid.Column="0" Text="Shadow Blur" Foreground="#9CA3AF"/>
                                <TextBlock Grid.Column="1" Text="{Binding ShadowBlur, StringFormat='{}{0}px'}" Foreground="White"/>
                            </Grid>
                            <Slider Minimum="0" 
                                    Maximum="100" 
                                    Value="{Binding ShadowBlur}"
                                    Background="#374151"/>
                        </StackPanel>

                        <!-- Output Ratio -->
                        <StackPanel Spacing="8">
                            <TextBlock Text="Output Ratio" Foreground="#9CA3AF"/>
                            <UniformGrid Columns="3" Rows="3">
                                <Button Content="Auto" Margin="2" Background="#8B5CF6" Foreground="White" CornerRadius="8"/>
                                <Button Content="1:1" Margin="2" Background="#374151" Foreground="White" CornerRadius="8"/>
                                <Button Content="4:3" Margin="2" Background="#374151" Foreground="White" CornerRadius="8"/>
                                <Button Content="3:2" Margin="2" Background="#374151" Foreground="White" CornerRadius="8"/>
                                <Button Content="16:9" Margin="2" Background="#374151" Foreground="White" CornerRadius="8"/>
                                <Button Content="5:3" Margin="2" Background="#374151" Foreground="White" CornerRadius="8"/>
                                <Button Content="9:16" Margin="2" Background="#374151" Foreground="White" CornerRadius="8"/>
                                <Button Content="3:4" Margin="2" Background="#374151" Foreground="White" CornerRadius="8"/>
                                <Button Content="2:3" Margin="2" Background="#374151" Foreground="White" CornerRadius="8"/>
                            </UniformGrid>
                        </StackPanel>

                        <!-- Gradient Presets -->
                        <StackPanel Spacing="8">
                            <TextBlock Text="Gradient Presets" Foreground="#9CA3AF"/>
                            <ItemsControl ItemsSource="{Binding GradientPresets}">
                                <ItemsControl.ItemsPanel>
                                    <ItemsPanelTemplate>
                                        <UniformGrid Columns="4" Rows="6" />
                                    </ItemsPanelTemplate>
                                </ItemsControl.ItemsPanel>
                                <ItemsControl.ItemTemplate>
                                    <DataTemplate>
                                        <Button Padding="0" BorderThickness="0" Background="Transparent"
                                                Command="{Binding DataContext.ApplyGradientPresetCommand, RelativeSource={RelativeSource AncestorType=UserControl}}"
                                                CommandParameter="{Binding}">
                                            <Border Width="50" Height="50" Margin="4" CornerRadius="10" Background="{Binding Brush}" ToolTip.Tip="{Binding Name}"/>
                                        </Button>
                                    </DataTemplate>
                                </ItemsControl.ItemTemplate>
                            </ItemsControl>
                        </StackPanel>
                    </StackPanel>
                </ScrollViewer>
            </Border>
        </Grid>

        <!-- Row 3: Export Toolbar (only visible when screenshot exists) -->
        <Border Grid.Row="3" 
                Background="#252535" 
                Padding="12,10"
                IsVisible="{Binding HasPreviewImage}">
            <DockPanel>
                <!-- Format Selection (Left) -->
                <Border DockPanel.Dock="Left" 
                        BorderThickness="0,0,1,0" 
                        BorderBrush="#3B3B52" 
                        Padding="0,0,12,0"
                        Margin="0,0,12,0">
                    <StackPanel Orientation="Horizontal" Spacing="8">
                        <TextBlock Text="Format" FontSize="11" Foreground="#94A3B8" VerticalAlignment="Center"/>
                        <StackPanel Orientation="Horizontal" Spacing="4">
                            <Button Content="PNG" 
                                    Width="60" Height="28"
                                    Background="#8B5CF6"
                                    Foreground="White"
                                    CornerRadius="8"
                                    FontSize="11"
                                    FontWeight="SemiBold"/>
                            <Button Content="JPEG" 
                                    Width="60" Height="28"
                                    Background="#25263A"
                                    BorderBrush="#3B3B52"
                                    BorderThickness="1"
                                    Foreground="White"
                                    CornerRadius="8"
                                    FontSize="11"/>
                        </StackPanel>
                    </StackPanel>
                </Border>
                
                <!-- Export Actions (Center-Right) -->
                <StackPanel Orientation="Horizontal" Spacing="8">
                    <Button Command="{Binding CopyCommand}">
                        <StackPanel Orientation="Horizontal" Spacing="6">
                            <TextBlock Text="ðŸ“‹" FontSize="14"/>
                            <TextBlock Text="Copy" FontSize="12"/>
                        </StackPanel>
                        <Button.Styles>
                            <Style Selector="Button">
                                <Setter Property="Background" Value="Transparent"/>
                                <Setter Property="BorderBrush" Value="#3B3B52"/>
                                <Setter Property="BorderThickness" Value="1"/>
                                <Setter Property="Foreground" Value="White"/>
                                <Setter Property="Padding" Value="12,6"/>
                                <Setter Property="CornerRadius" Value="8"/>
                            </Style>
                        </Button.Styles>
                    </Button>
                    
                    <Button Command="{Binding QuickSaveCommand}">
                        <StackPanel Orientation="Horizontal" Spacing="6">
                            <TextBlock Text="â¬‡" FontSize="14"/>
                            <TextBlock Text="Quick Save" FontSize="12"/>
                        </StackPanel>
                        <Button.Styles>
                            <Style Selector="Button">
                                <Setter Property="Background" Value="#14B8A680"/>
                                <Setter Property="BorderBrush" Value="#14B8A64D"/>
                                <Setter Property="BorderThickness" Value="1"/>
                                <Setter Property="Foreground" Value="#5EEAD4"/>
                                <Setter Property="Padding" Value="12,6"/>
                                <Setter Property="CornerRadius" Value="8"/>
                            </Style>
                        </Button.Styles>
                    </Button>
                    
                    <Button Command="{Binding SaveAsCommand}">
                        <StackPanel Orientation="Horizontal" Spacing="6">
                            <TextBlock Text="ðŸ’¾" FontSize="14"/>
                            <TextBlock Text="Save As..." FontSize="12"/>
                        </StackPanel>
                        <Button.Styles>
                            <Style Selector="Button">
                                <Setter Property="Background" Value="#8B5CF6"/>
                                <Setter Property="Foreground" Value="White"/>
                                <Setter Property="Padding" Value="16,6"/>
                                <Setter Property="CornerRadius" Value="8"/>
                                <Setter Property="FontWeight" Value="SemiBold"/>
                            </Style>
                        </Button.Styles>
                    </Button>
                </StackPanel>
            </DockPanel>
        </Border>

        <!-- Row 4: Status Bar (always visible) -->
        <Border Grid.Row="4" Background="#1E1E2E" Padding="16,8">
            <DockPanel>
                <!-- Right: Version Info (Strictly Bottom Right) -->
                <TextBlock DockPanel.Dock="Right" 
                           Text="{Binding AppVersion}" 
                           Foreground="#8B5CF6"
                           FontSize="12"
                           FontWeight="SemiBold"
                           VerticalAlignment="Center"
                           Margin="12,0,0,0"/>

                <!-- Left: Status Message / Image Dimensions -->
                <StackPanel DockPanel.Dock="Left" Orientation="Horizontal" Spacing="8" Margin="0,0,16,0">
                    <Ellipse Width="8" Height="8" 
                             Fill="#64748B"
                             VerticalAlignment="Center"/>
                    <TextBlock Text="{Binding StatusText, FallbackValue='Ready'}" 
                               Foreground="#94A3B8"
                               FontSize="12"
                               VerticalAlignment="Center"/>
                </StackPanel>

                <!-- Left: Zoom Controls -->
                <StackPanel DockPanel.Dock="Left" Orientation="Horizontal" Spacing="6" VerticalAlignment="Center">
                    <Button Width="28" Height="28" CornerRadius="6" Background="#25263A" BorderBrush="#3B3B52" BorderThickness="1"
                            Command="{Binding ZoomOutCommand}" ToolTip.Tip="Zoom out (Ctrl + Wheel)">
                        <TextBlock Text="-" Foreground="#E2E8F0" FontSize="14" HorizontalAlignment="Center" VerticalAlignment="Center"/>
                    </Button>
                    <Slider Width="140"
                            Minimum="0.25" Maximum="4"
                            SmallChange="0.1" LargeChange="0.25"
                            Value="{Binding Zoom}"
                            VerticalAlignment="Center"/>
                    <Button Width="28" Height="28" CornerRadius="6" Background="#25263A" BorderBrush="#3B3B52" BorderThickness="1"
                            Command="{Binding ZoomInCommand}" ToolTip.Tip="Zoom in (Ctrl + Wheel)">
                        <TextBlock Text="+" Foreground="#E2E8F0" FontSize="14" HorizontalAlignment="Center" VerticalAlignment="Center"/>
                    </Button>
                    <Button Width="52" Height="28" CornerRadius="6" Background="#14B8A680" BorderBrush="#14B8A64D" BorderThickness="1"
                            Command="{Binding ResetZoomCommand}" ToolTip.Tip="Reset zoom">
                        <TextBlock Text="100%" Foreground="#5EEAD4" FontSize="12" FontWeight="SemiBold" HorizontalAlignment="Center" VerticalAlignment="Center"/>
                    </Button>
                    <TextBlock Text="{Binding Zoom, StringFormat='{}{0:P0}'}" 
                               Foreground="#E2E8F0"
                               FontSize="12"
                               VerticalAlignment="Center"
                               Margin="4,0,0,0"/>
                </StackPanel>
            </DockPanel>
        </Border>

        <!-- Effects Panel Overlay (Grid.RowSpan=5 to cover entire view) -->
        <Border Grid.Row="0" Grid.RowSpan="5"
                IsVisible="{Binding IsEffectsPanelOpen}"
                Background="#80000000"
                HorizontalAlignment="Right"
                VerticalAlignment="Stretch"
                Width="400"
                Padding="16">
            <views:EffectsPanelView DataContext="{Binding EffectsPanel}"
                                    ApplyRequested="OnEffectsPanelApplyRequested"/>
        </Border>
    </Grid>
</UserControl>
